---
category: [編程]
tags: [Linux, IoT]
title: ELF 格式介紹
date: 2024-09-01 18:00:00
---

<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>

#  ELF 格式介紹

可执行与可连结格式（英语：Executable and Linkable Format，缩写ELF，此前的写法是Extensible Linking Format），常被称为ELF格式，在计算中，是一种用于可执行档案、目的码、共享库 和核心转储（core dump）的标准档案格式。在 Linux 平台上通用的二进制文件格式及在 Android 的 NDK 开发中，几乎都是 ELF。

![Alt x](../assets/img/linux/elf_f.png)

## ELF 文件的主要组件

ELF 文件有三个主要组件组成：

 - ELF 头 (Header)
 - 节 (Sections) 
 - 段 (Segments)

每个元素在 ELF 可执行文件的链接/加载过程中都发挥着不同的作用。以下将讨论每个组件以及段和节之间的关系。

![Alt x](../assets/img/linux/elf_full.png)

### ELF 头 (Header)

ELF 文件开始，包含文件结构的说明信息，分 32 位系统和 64 位系统，下面分别是 32 位系统和 64 位系统对应的 ELF 头的数据结构。

![Alt x](../assets/img/linux/elf_type.png)

ELF 的魔数：7f 45 4c 46 (其中 45 4c 46 是 ELF 的 ASCII 码值)

### 节 (Sections) 

![Alt x](../assets/img/linux/elf_c.png)

系统预定义了一些节名（以.开头），这些节有其特定的类型和含义。


|節名|说明|
|:---:|:---|
|.**text**|保存程序的指令代码|
|.**bss**|程序运行时未初始化的全局变量和静态变量|
|.**data** <br/> .**data1**|初始化的全局变量和静态变量|
|.**rodata**<br/>.**rodata1**|只读数据，组成不可写的段|
|.**init**<br/>.**init_array**|程序运行时，先执行该节中的代码和.fini对应|
|.**fini**<br/>.**fini_array**|程序正常结束时要执行该指令|
|.**strtab**|字符串，是符号表中符号对应的名字|
|.**symtab**|符号表定位、重定位符号定义和引用时需要的信息|
|.**debug**|符号调试用的信息，用于**gdb**等工具调试程序|
|.**comment**|版本控制信(不包含已经被删除的信息)|
|.**dynamic**|动态链接的信息|
|.**dynstr**|动态链接用的字符串，通常是和符号表中的符号关联的字符串|
|.**dynsym**|动态链接符号表|
|.**got**|全局偏移表(global offset table)|
|.**hash**|符号hash表|
|.**interp**|内容是一个字符串，指定了程序解释器的路径名。如文件中有一个可加载的segment包含该节，属性就包含SHF_ALLOC，否则不包含|
|.**line**|符号调试的行号信息，描述了源程序和机器代码的对应关系。gdb等调试器需要此信息|
|.**note**||
|.**plt** |过程链接表(Procedure Linkage Table)|
|.**relNAME**|重定位信息。如文件有一个可加载的segment包含该section，section属性将包含SHF_ALLOC，否则不包含。NAME，是应用重定位的节的名字，比如.text的重定位信息存储在.rel.text中|
|.**relaname**|和.rel相同|
|.**shstrtab**|共用一块存储空间|





.shstrtab：只是一个以 NULL 结尾的字符串数组，其中包含二进制文件中所有部分的名称。

.symtab：包含一个符号表，它是一个 ElfN_Sym 结构表，每个结构都将符号名称与二进制文件中其他位置的一段代码或数据（例如函数或变量）相关联。

.strtab：包含含有符号名称的字符串。这些字符串由 ElfN_Sym 结构指向。

.dynsym：与 .symtab 相同，但包含动态链接而非静态链接所需的符号。

.dynstr：与 .strtab 相同，但包含动态链接而非静态链接所需的字符串。

.interp：RTLD 嵌入字符串。

.rel.dyn：全局变量重定位表。

.rel.plt：函数重定位表。

旧版 gcc 部分：

.ctors：与旧版 gcc 生成的 .init_array 等效。

 .dtors：相当于旧版本 gcc 生成的 .fini_array。



### 段 (Segments)

要注意区分段 (<font color="#FF1000">segment</font>) 和节 (<font color="#FF1000">section</font>) 的概念，在写汇编程序时用 .text， .bss， .data 这些指示，都指的是 section，比如 .text，告诉汇编器后面的代码放入 .text section 中。
目标代码文件中的 section 和 section header table 中的条目是一一对应的。section 的信息用于链接器对代码重定位。

而文件载入内存执行时，是以 segment 组织的，每个 segment 对应 **ELF** 文件中 **program header table** 中的一个条目，用来建立可执行文件的进程映像。
通常，代码段、数据段是**segment**，目标代码中的**section** 会被链接器组织到可执行文件的各个 **segment** 中。.text section 的内容会组装到代码段中 .data, .bss 等节的内容会包含在数据<font color="#FF1000">Segments</font>段中。



![Alt x](../assets/img/linux/elf_segment.png)


![Alt x](../assets/img/linux/elf_sample.png)