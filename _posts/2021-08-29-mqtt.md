---
category: 電腦
tags: [IoT]
---


# MQTT

## MQTT是一種 machine-to-machine 的輕量級通訊協定，讓各種設備互相溝通。


透過 **Publish** 發送資料，讓 **Subscribe** 接收資料，一次可能會有好多組 **Publish** 與 **Subscribe**，就是透過中間的 **Broker** 去根據不同的主題（Topic）做資料派送。

![]({{ '/assets/img/IoT/mqtt.png' | relative_url }})


## 如何在 Linux 環境中使用 NodeJs 設置 **Broker** 代理

為了在網頁中使用，可以使用 **websocket** 作為通信連接方式

```
$ npm install aedes
$ npm install http
$ npm install websocket-stream
$ npm install aedes-server-factory
$ npm install mqtt
```


**Broker** mqtt-broker.js 使用 websocket 派送資料

```
const aedes = require('aedes')()
const { createServer } = require('aedes-server-factory')
const port = 8888

const httpServer = createServer(aedes, { ws: true })

httpServer.listen(port, function () {
  console.log('websocket server listening on port ', port)
})
```

使用 NodeJs 命令來操作 mqtt-broker.js

```
$ node ./mqtt-broker.js
```


**Publish** mqtt-pub.js 使用 **websocket** 發送資料

```
var mqtt = require("mqtt")
var client = mqtt.connect("ws://61.238.204.141:8888")

client.on("connect", (e) => {
    console.log("success connect mqtt websocket server");
    setInterval(() => {
        client.publish("temp", "25.6")
        console.log("send it")
    }, 1000)
})
```


使用 NodeJs 命令來操作 mqtt-pub.js

```
$ node ./mqtt-pub.js
```


**Subscribe** mqtt-sub.js 使用 websocket 接收資料

```
var mqtt = require("mqtt")
var client = mqtt.connect("ws://61.238.204.141:8888")

client.on('connect', (e) => {
  console.log("success connect mqtt websocket server");
  client.subscribe('temp', function (err) {
    console.log("subscribe temp topic")
  })
})

client.on('message', function (topic, message) {
  // message is Buffer
  console.log(topic + ":\t" + message.toString())
})
```


使用 NodeJs 命令來操作 mqtt-pub.js

```
$ node ./mqtt-sub.js
```
