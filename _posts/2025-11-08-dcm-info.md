---
category: [MPU]
tags: [IoT, 编程, 数学]
title: DCM 方向余弦矩阵
date: 2025-11-08 12:00:00
---

<style>
  table {
    width: 100%
    }
  td.left {
    vertical-align: center;
    text-align: left;
    width: 30%;
  }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  tr:nth-child(even){
    background-color:#ffffe5;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>


# DCM (方向余弦矩阵)


## 什么是姿态

姿态是指物体坐标系(运动坐标系)与固定坐标系的相对旋转关系，如飞机的机体坐标系与大地坐标系的关系。

以飞机的姿态进行说明，起飞前机体坐标系与大地坐标系重合，飞向空中后，机体坐标系一般会与大地坐标系产生偏差，此刻机体坐标系到大地坐标系的变换可以分解为起飞前的机体坐标系绕不同的坐标轴连续转动3次。

这里的“绕不同的坐标轴”有两重含义。

绕固定坐标系(大地坐标系)的坐标轴或者绕运动坐标系(机体坐标系)的坐标轴，前者称为外旋，后者称为内旋。
旋转轴的顺序，先绕 X 轴再 Y 轴最后 Z 轴，或者先绕 Z 轴再 Y 轴最后 X 轴等等顺序。
通过上述两种含义，共有 24 种组合方式。但一般用的为以下两种方法

 - 绕 Z-Y-X 的顺时针內旋（右乘），即 **NED**
 - 绕 X-Y-Z 的顺时针外旋（左乘），即 **ENU**  


## 坐标轴方向

 - NED: North-East-Down（北-东-下）坐标系用于航空航天和海洋应用，其坐标轴指向北、东、下。坐标系的正 z 轴指向地心。
 - ENU: East-North-Up（东-北-上）坐标系常用于陆地机器人和大地测量学，其坐标轴指向东、北、上。右手坐标系，其正 z 轴指向远离地心的方向。


|特征|NED（北-东-下）|ENU（东-北-上）|
|:---:|:---:|:---:|
|应用|飞机、船舶、潜艇|陆地车辆、机器人|
|主轴|X轴：北，Y轴：东，Z轴：下|X轴：东，Y轴：北，Z轴：上|
|Z 轴方向|向下指向地心|向上指向远离地心|
|旋向|左旋系统 y-x-z|右旋系统 x-y-z|


### 三轴旋转

$$
\psi_{z} = yaw = y， \\ \phi_{y} = pitch = p， \\ \theta_{x} = roll = r，
$$

## NED (地心地平坐标系) - 航天和海洋

### NED 方向余弦矩阵（将向量从本体坐标系转换为世界坐标系）

![Alt X](../assets/img/3d/ned-fig.png)

![Alt X](../assets/img/3d/rh-xyz.png)


### 欧拉角转余弦矩阵

$$
R_{zyx}(y,p,r)= \psi_{z}\phi_{y} \theta_{x} =  \begin{bmatrix} cos(\psi) & -sin(\psi) & 0\\ sin(\psi) & cos(\psi) & 0\\ 0 & 0 & 1 \end{bmatrix} \begin{bmatrix} cos(\phi) & 0 & sin(\phi)\\ 0 & 1 & 0 \\ -sin(\phi) & 0 & cos(\phi) \end{bmatrix}
\begin{bmatrix} 1 & 0 & 0 \\ 0 & cos(\theta) & -sin(\theta)\\ 0 & sin(\theta) & cos(\theta) \end{bmatrix}
$$


$$
\small 
R_{zyx}(y,p,r)= \psi_{z}\phi_{y} \theta_{x} =
\begin{bmatrix}cos(y)cos(p) & cos(y)sin(p)sin(r) - sin(y)cos(r) & cos(y)sin(p)cos(r) + sin(y)sin(r)\\
sin(y)cos(p) & sin(y)sin(p)sin(r) + cos(y)cos(r) & sin(y)sin(p)cos(r) - cos(y)sin(r)\\
-sin(p) & cos(p)sin(r) & cos(p)cos(r)\\
\end{bmatrix}
$$

### 余弦矩阵转欧拉角 (Gimbal lock 问题)

$$
C_{31} \neq \pm 1， \\
\theta = tan^{-1} \frac {C_{32}} {C_{33}} \\
\phi = sin^{-1} -C_{31} \\
\psi = tan^{-1} \frac {C_{21}} {C_{11}}  
$$

### 四元数转欧拉角


$$
\begin{bmatrix} roll_x \\ pitch_y \\ yaw_z \\ \end{bmatrix} = \begin{bmatrix} \theta \\ \phi \\ \psi \\ \end{bmatrix} = \begin{bmatrix} 
\operatorname{atan2}(2(q_wq_x + q_yq_z), q_w^2 - q_x^2 - q_y^2 + q_z^2) \\ 
\operatorname{asin}(2(q_wq_y - q_zq_x)) \\
\operatorname{atan2}(2(q_wq_z + q_xq_y), q_w^2 + q_x^2 - q_y^2 - q_z^2)
\end{bmatrix}
$$

### 欧拉角转四元数


$$
q = \begin{bmatrix} q_w \\ q_x \\ q_y \\ q_z \\ \end{bmatrix} = \begin{bmatrix} cos(\frac {\theta}{2})cos(\frac {\phi}{2})cos(\frac {\psi}{2}) + sin(\frac {\theta}{2})sin(\frac {\phi}{2})sin(\frac {\psi}{2})\\ sin(\frac {\theta}{2})cos(\frac {\phi}{2})cos(\frac {\psi}{2}) - cos(\frac {\theta}{2})sin(\frac {\phi}{2})sin(\frac {\psi}{2}) \\ cos(\frac {\theta}{2})sin(\frac {\phi}{2})cos(\frac {\psi}{2}) + sin(\frac {\theta}{2})cos(\frac {\phi}{2})sin(\frac {\psi}{2}) \\ cos(\frac {\theta}{2})cos(\frac {\phi}{2})sin(\frac {\psi}{2}) - sin(\frac {\theta}{2})sin(\frac {\phi}{2})cos(\frac {\psi}{2}) \\ \end{bmatrix}
$$


## ENU (大地直角坐标系) - 陆地

### ENU 方向余弦矩阵（将向量从本体坐标系转换为世界坐标系）

![Alt X](../assets/img/3d/enu-fig.png)

![Alt X](../assets/img/3d/lh-xyz.png)

### 欧拉角转余弦矩阵

$$
R_{xyz}(r,p,y) = \theta_{x}\phi_{y}\psi_{z} = 
\begin{bmatrix} 1 & 0 & 0 \\ 0 & cos(\theta) & sin(\theta)\\ 0 & -sin(\theta) & cos(\theta) \end{bmatrix}
\begin{bmatrix} cos(\phi) & 0 & -sin(\phi)\\ 0 & 1 & 0 \\ sin(\phi) & 0 & cos(\phi) \end{bmatrix}
\begin{bmatrix} cos(\psi) & sin(\psi) & 0\\ -sin(\psi) & cos(\psi) & 0\\ 0 & 0 & 1 \end{bmatrix} 
$$

$$
\small 
R_{xyz}(r,p,y) = \theta_{x}\phi_{y}\psi_{z} =
\begin{bmatrix}
 cos(p)cos(y) & cos(p)sin(y) &  -sin(p) \\
sin(r)sin(p)cos(y) - cos(r)cos(y) & sin(r)sin(p)sin(y) + cos(r)cos(y) & sin(r)cos(p)\\
cos(r)sin(p)cos(y)+sin(r)sin(y) & cos(r)sin(p)sin(y) - sin(r)cos(y) & cos(r)cos(p)
\end{bmatrix}
$$

### 余弦矩阵转欧拉角 (Gimbal lock 问题)

 
$$
C_{31} \neq \pm 1， \\
\theta = tan^{-1} \frac {C_{32}} {C_{33}} \\
\phi = sin^{-1} -C_{31} \\
\psi = tan^{-1} \frac {C_{21}} {C_{11}}  
$$

### 四元数转欧拉角


$$
\begin{bmatrix} roll_x \\ pitch_y \\ yaw_z \\ \end{bmatrix} = \begin{bmatrix} \theta \\ \phi \\ \psi \\ \end{bmatrix} = \begin{bmatrix} 
\operatorname{atan2}(2(q_wq_x + q_yq_z), q_w^2 - q_x^2 - q_y^2 + q_z^2) \\ 
\operatorname{asin}(2( q_wq_y - q_zq_x)) \\
\operatorname{atan2}(2( q_wq_z + q_xq_y), q_w^2 + q_x^2 - q_y^2 - q_z^2)
\end{bmatrix}
$$


### 欧拉角转四元数

$$
q = \begin{bmatrix} q_w \\ q_x \\ q_y \\ q_z \\ \end{bmatrix} = \begin{bmatrix} cos(\frac {\theta}{2})cos(\frac {\phi}{2})cos(\frac {\psi}{2}) - sin(\frac {\theta}{2})sin(\frac {\phi}{2})sin(\frac {\psi}{2})\\ sin(\frac {\theta}{2})cos(\frac {\phi}{2})cos(\frac {\psi}{2}) + cos(\frac {\theta}{2})sin(\frac {\phi}{2})sin(\frac {\psi}{2}) \\ cos(\frac {\theta}{2})sin(\frac {\phi}{2})cos(\frac {\psi}{2}) - sin(\frac {\theta}{2})cos(\frac {\phi}{2})sin(\frac {\psi}{2}) \\ cos(\frac {\theta}{2})cos(\frac {\phi}{2})sin(\frac {\psi}{2}) + sin(\frac {\theta}{2})sin(\frac {\phi}{2})cos(\frac {\psi}{2}) \\ \end{bmatrix}
$$

# 姿态计算的相关公式

## 基本运算公式

假设一开始没有任何的旋转，姿态是跟参考坐标系重合，θ 等于 0：

$$
q = [cos \frac{θ}{2}, -x sin \frac{θ}{2}, -y sin \frac{θ}{2}, -z sin \frac{θ}{2}] = [1, 0, 0, 0]
$$

其中 θ 是旋转过的角度，x, y, z 是旋转轴上的单位矢量的分量 。

如要求 $q_A$ 相对于 $q_B$ 的姿态，这可以通过四元数的共轭 $\bar{q}$ 来算：

$$
\bar{q} = [cos \frac{θ}{2}, x sin \frac{θ}{2}, y sin \frac{θ}{2}, z sin \frac{θ}{2}]
$$

注：共轭是有标量部分，而逆 $q^{-1}$ 是归一化後的共轭。即 

$$
q^{-1} = \frac {\bar{q}}{|q|}
$$

## 姿态的坐标变换 (不受 X，Y，Z 顺序影响)

### 四元数

$$
q =  q_w + q_x + q_y + q_z \\  q_w = w
$$


### 余弦矩阵

$$
C =  \begin{bmatrix}
C_{11} & C_{12} & C_{13} \\
C_{21} & C_{22} & C_{23} \\
C_{31} & C_{32} & C_{33} 
\end{bmatrix}
$$


### 四元数转余弦矩阵 (NED)

**从传感器框架到 NED 参考框架**


$$
{C_b}^N = \begin{bmatrix}
 q_w^2 + q_x^2 - q_y^2 - q_z^2 & 2(q_xq_y - q_wq_z) & 2(q_xq_z + q_wq_y) \\
2(q_xq_y + q_wq_z) &  q_w^2 - q_x^2 + q_y^2 - q_z^2 & 2(q_yq_z - q_wq_x) \\
2(q_xq_z - q_wq_y) & 2(q_yq_z + q_wq_x) &  q_w^2 - q_x^2 - q_y^2 + q_z^2
\end{bmatrix}
$$

**从 NED 参考框架到传感器框架**


$$
{C_N}^b = \begin{bmatrix}
 q_w^2 + q_x^2 - q_y^2 - q_z^2 & 2(q_xq_y + q_wq_z) & 2(q_xq_z - q_wq_y) \\
2(q_xq_y - q_wq_z) &  q_w^2 - q_x^2 + q_y^2 - q_z^2 & 2(q_yq_z + q_wq_x) \\
2(q_xq_z + q_wq_y) & 2(q_yq_z - q_wq_x) &  q_w^2 - q_x^2 - q_y^2 + q_z^2
\end{bmatrix}
$$


### 余弦矩阵转四元数

$$
T = C_{11} + C_{22} + C_{33}
$$


|条件|最大|$q_w$|$q_x$|$q_y$|$q_z$|
|:---:|:---:|:---:|:---:|:---:|
|$T>0$| - |$\frac {1}{2} \sqrt {1 + T}$|$\frac {C_{32} - C_{23}}{4 q_w}$|$\frac {C_{13} - C_{31}}{4 q_w}$|$\frac {C_{21} - C_{12}}{4 q_w}$|
|$T≤0$|$C_{11}$|$\frac {C_{32} - C_{23}}{4 q_x}$|$\frac {1}{2} \sqrt {1 + C_{11} - C_{22} - C_{33}}$|$\frac {C_{12} - C_{21}}{4 q_x}$|$\frac {C_{13} - C_{31}}{4 q_x}$|
|$T≤0$|$C_{22}$|$\frac {C_{13} - C_{31}}{4 q_y}$|$\frac {C_{12} - C_{21}}{4 q_y}$|$\frac {1}{2} \sqrt {1 - C_{11} + C_{22} - C_{33}}$|$\frac {C_{23} - C_{32}}{4 q_y}$|
|$T≤0$|$C_{33}$|$\frac {C_{21} - C_{12}}{4 q_z}$|$\frac {C_{13} - C_{31}}{4 q_z}$|$\frac {C_{23} - C_{32}}{4 q_z}$|$\frac {1}{2} \sqrt {1 - C_{11} - C_{22} + C_{33}}$|