---
category: [MPU]
tags: [IoT, 编程]
title: 惯性测量传感器 IMU 详解
date: 2025-11-15 12:00:00
---

<style>
  table {
    width: 100%
    }
  td.left {
    vertical-align: center;
    text-align: left;
    width: 30%;
  }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  tr:nth-child(even){
    background-color:#ffffe5;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>



# 惯性测量传感器详解

基于之前文章 [惯性测量传感器 IMU](https://hkdickyko.github.io/mpu/imu) 再深入解释，一些细节的数学部份。如 **灵敏度矩阵** 计算及各传感器的专属公式等。

## 陀螺仪

通常做为主要姿态的计算，优点是反应快，但缺点是误差容易累积。陀螺仪是测量角速度的元件，陀螺仪有短时间准确、灵敏的特性，但用来计算角度时，长时间下的误差累积会使其变的不可靠，通常以 dps（degree per second）来表示角速度，角速度与速度不同，角速度是单位时间内旋转的角度，而速度则是单位时间内移动的距离，所以若是没有旋转是没有角速度的，若只对 X 轴旋转，则 Y 轴与 Z 轴的输出为 0，X 轴的输出为旋转的角速度。

感测器都会有误差与杂讯，把误差与噪音杂讯给滤除掉可以下面的数学式表示从感测器读到的角速度 $w_{measure}$ 会等于矩阵 $R_{gyro}$ 乘上理想的角速度 $w_{real}$ 加上偏移 $w_{bias}$ 与杂讯 $n_{noise}$，矩阵 $R_{gyro}$ 包含未对准误差（Misalignment）以及单位转换（dps/LBS），若感测器与载具完全对准的情况（大部份安装不准等情况会造成未对准误差），矩阵 $R_{gyro}$ 会是一个对角矩阵（Diagonal Matrix），偏移 $w_{bias}$、杂讯 $n_{noise}$ 则由温度、感测器内部等干扰引起。


$$
w_{measure} = R_{gyro} w_{real} + w_{bias} + n_{noise}
$$


$$
w_{measure} = \begin{bmatrix} w_x \\ w_y \\ w_z \end{bmatrix} = \begin{bmatrix} R_{11} && R_{12} && R_{13} \\ R_{21} && R_{22} && R_{23} \\ R_{31} && R_{32} && R_{33}  
\end{bmatrix} \begin{bmatrix} w_{rx} \\ w_{ry} \\ w_{rz} \end{bmatrix} + \begin{bmatrix} b_{wx} \\ b_{wy} \\ b_{wz} \end{bmatrix} + \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix}
$$


陀螺仪校正的部分主要校正偏差（Bias）的误差，不对安装误差做校正，因为对于安装物差的校正需要一些＂绝对＂的测量数据，这些数据通常都需要外部的仪器来辅助校正与测量。例如想要找出下列方程式中的 $R_{gyro}$ 矩阵，找出这一个矩阵的一个方法就是在不同的角速度下测量，外部的装置可以产生一个固定的角​​速度给予感测器，或是透过另一个可靠的感测器来做提供实际的结果，而感测器将测量到的结果与实际的结果作比较，就可以得出 $R_{gyro}$ 矩阵，$R_{gyro}$ 矩阵是一个单位矩阵或是一个对角矩阵（Diagonal Matrix）。

$$
w_{real} = {R_{gyro}}^{-1}(w_{measure} - w_{bias} - n_{noise})
$$


**高斯噪音（Gaussian Noise）下，平均值为 $n_{noise}=0$**

$$
w_{real} = \begin{bmatrix} w_{rx} \\ w_{ry} \\ w_{rz} \end{bmatrix} = \begin{bmatrix} R_{11} && 0 && 0 \\ 0 && R_{22} && 0 \\ 0 && 0 && R_{33} \end{bmatrix}^{-1} \begin{bmatrix} w_x - b_{wx} - 0\\ w_y - b_{wy} - 0\\\ w_z - b_{wz} - 0 \end{bmatrix}
$$

假设 $R_{gyro}$ 是一个对角矩阵后，问题简化许多，在 $n_{noise}$ 为高斯噪音（Gaussian Noise）下，平均值为 0，静止下对陀螺仪取样 $w_{real}$ = 0，所以测量到的就是 $w_{bias}$，只要在每次测量的结果减掉 $w_{bias}$，并乘上一个放大缩小的变数，就可以得出理想的陀螺仪资料，说的简单一点就是在静止下取平均值就可以得出 $w_{bias}$。


**静止下对陀螺仪 $w_{real}=0$**

$$
\because \begin{bmatrix} w_{rx} \\ w_{ry} \\ w_{rz} \end{bmatrix} = \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix} = \begin{bmatrix} w_x - b_{wx} - 0\\ w_y - b_{wy} - 0\\\ w_z - b_{wz} - 0 \end{bmatrix}
$$

$$
\therefore w_x = b_{wx}，w_y = b_{wy}，w_z = b_{wz}
$$

通过在已知旋转角度下对一系列角速度值进行时间积分，来进一步测试陀螺仪的校准情况。例如，可以将模块旋转180°，并对陀螺仪进行时间积分，以验证陀螺仪是否正常工作。

通过对陀螺仪的角速度进行积分，可以近似计算角位移：

$$
\theta = \int_{t_0}^{t_1} w_i dt 
$$

对于离散点，需要采用数值积分技术，我们采用梯形数值积分法：

$$
\theta_i = \int_{t_0}^{t_N} w_i dt \simeq  \sum_{j=1}^{N} \left(\frac{f_{i}(t_{j-1}) - f_{i}(t_{j})}{2} \Delta t \right)
$$

以上计算为灵敏度矩阵的对角元素，非对角元素是因未对准误差还会对每个轴产生横向影响。量化这些影响需要将每个轴的未对准角度分解为两个分量，这两个分量分别与另外两个轴相关。例如，$\theta_x$ 具有 $y$ 轴分量 $\delta_{xy}$ 和 $z$ 轴分量 $\delta_{xz}$，这导致 $x$ 轴陀螺仪对绕全局坐标系中所有三个轴 $w_x，w_y，w_z$ 旋转的响应展开如下：


$$
g_x = w_x cos(\theta_{x}) + w_y sin(\delta_{xy}) + w_z sin(\delta_{xz})，\\
g_y = w_x sin(\delta_{yx}) + w_y cos(\phi_{y}) + w_z sin(\delta_{yz})，\\
g_z = w_x sin(\delta_{zx}) + w_y sin(\delta_{zy}) + w_z cos(\psi_{z})，
$$


## 加速度计

可以透过重力加速度来校正陀螺仪，运动加速度部分也可以用来计算位移与速度等。加速度计是测量加速度的元件，除了运动加速度外，也包含地球质量所产生的重力加速度，也就是当感测器自由落体时，运动加速度与重力加速度会刚好抵销，有输出都会变成 0，通常以 $g$ 或是 $m/s^2$ 来表示，因为可以感测到重力加速度，所以在有重力的环境中加速度计也常用来做倾斜计，透过重力在三轴上的投影来计算角度。


加速度计常常会搭配陀螺仪来应用，因为重力加速度并不会随时间快速变化，长时间具有可靠性，所以通常透过此特性来较正陀螺仪，防止误差的累积。


加速度计的输出 $a_{measure}$ 会等于矩阵 $K_{accel}$ 乘上理想的加速度 $a_{real}$ 加上偏移 $a_{bias}$ 与杂讯 $n_{noise}$，理想的加速度 $a_{real}$ 包含运动加速度 $a_{motion}$ 以及重力加速度 $a_{gravity}$，矩阵 $K_{accel}$ 包含未对准的误差以及单位的转换（g/LBS），若感测器与载具完全对准的情况，矩阵 $K_{accel}$ 也是一个对角矩阵，偏移 $a_{bias}$、杂讯 $n_{noise}$ 则也会由温度、感测器内部等干扰引起。


$$
a_{measure} = K_{accel} a_{real} + a_{bias} + n_{noise} 
$$

$$
a_{real} = a_{motion} + a_{gravity}
$$

**高斯噪音（Gaussian Noise）下，平均值为 $n_{noise}=0$**

$$
a_{measure} = \begin{bmatrix} a_x \\ a_y \\ a_z \end{bmatrix} = \begin{bmatrix} K_{11} && K_{12} && K_{13} \\ K_{21} && K_{22} && K_{23} \\ K_{31} && K_{32} && K_{33} \end{bmatrix} \begin{bmatrix} a_{rx} \\ a_{ry} \\ a_{rz} \end{bmatrix} + \begin{bmatrix} b_{ax} \\ b_{ay} \\ b_{az} \end{bmatrix} + \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix}
$$


对加速度计校正的部分除了 $B_{bias}$ 矩阵的偏差外，还会找出 $S$ 矩阵来校正比例误差与焊接、安装产生的未对准误差，而三轴间的正交误差不打算特别做校正，因为使用的感测器是三轴集成于一颗芯片的，所以直接假设三轴互相正交，则 $S$ 的反矩阵（$K$ 矩阵）会是一个对证矩阵，并且表示成无偏差的形式，为的是减少展开的复杂度，所以问题可以化简成下面式子


$$
a_{real} = {K_{accel}}^{-1}(a_{measure} - a_{bias} - n_{noise})
$$

$$
a_{real} = \begin{bmatrix} a_{rx}  \\ a_{ry} \\ a_{rz} \end{bmatrix} = {\begin{bmatrix} K_{11} && K_{12} && K_{13} \\ K_{21} && K_{22} && K_{23} \\ K_{31} && K_{32} && K_{33} \end{bmatrix}}^{-1} \begin{bmatrix} a_{x} - b_{ax} - 0 \\ a_{y} - b_{ay} - 0 \\ a_{z} - b_{az} - 0 \end{bmatrix}
$$


再透过在没有运动加速度的条件下，加速度计三轴输出平方和会等于重力加速度的关系来做校正，此种方法不需要依预先设定好的角度与位置来校正，校正的自由度较大。


$$
g^2 = a_{rx}^2 + a_{ry}^2 + a_{rz}^2
$$

在 $z$ 轴加速度计与重力方向平行且向下以及向上时测量值。这两种情况下的值已知，向下为 $+9.8$，向上为 $-9.8$。


$$
+9.81 = S_z (a_{z0} - b_{az}) \\ -9.81  = S_z (a_{z1} - b_{az})
$$

$$
\frac {9.81 + b_{az}} {a_{z0}} = S_z =  \frac {-9.81 + b_{az}} {a_{z1}}，\\
a_{z1}(9.81 + b_{az}) = a_{z0} (-9.81 + b_{az})， \\
9.81 \cdot a_{z1} + b_{az} a_{z1} = -9.81 \cdot a_{z0} + b_{az} a_{z0}， \\
9.81(a_{z1} + a_{z0}) = b_{az} (a_{z0} - a_{z1}) $$


$$
b_{az} = 9.81 \left ( \frac {a_{z0} + a_{z1}} {a_{z0} - a_{z1}} \right )
$$


$$
S_z a_{z0} - 9.81 = S_z \cdot b_{ax} = 
S_z a_{z01} + 9.81， \\
S_z a_{z0} - 9.81 = S_z a_{z1} + 9.81， \\
S_z (a_{z0} - a_{z1}) = 2 \cdot 9.81
$$


$$
K_{33} = S_z  = \frac {2 \cdot 9.81} {a_{z0} - a_{z1}}
$$

**其他轴的计算方法类似**。

$$
b_{ax} = 9.81 \left ( \frac {a_{x0} + a_{x1}} {a_{x0} - a_{x1}} \right )，K_{11} = S_x  = \frac {2 \cdot 9.81} {a_{x0} - a_{x1}}\\ b_{ay} = 9.81 \left ( \frac {a_{y0} + a_{y1}} {a_{y0} - a_{y1}} \right )，K_{22} = S_y  = \frac {2 \cdot 9.81} {a_{y0} - a_{y1}} \\ b_{az} = 9.81 \left ( \frac {a_{z0} + a_{z1}} {a_{z0} - a_{z1}} \right )，K_{33} = S_z  = \frac {2 \cdot 9.81} {a_{z0} - a_{z1}}
$$

以上计算为灵敏度矩阵的对角元素，详细介绍如下：

 - 对角元素 ($K_{11}，K_{22}，K_{33}$): 这些元素表示每个轴（$x、y$ 和 $z$）对沿该轴加速度的主要灵敏度，单位为 $mV/g$ 或 $LSB/g$。
 - 非对角元素 ($K_{12}，K_{13}，K_{21}，K_{23}，K_{31}，K_{32}$): 这些元素表示交叉灵敏度，即一个轴上的加速度会在另一个轴上产生响应。例如 $K_{12}$ 表示 y 轴上的加速度引起的 x 轴上的响应。因为 $x=1，y=2，z=3$，一般数值会少于对角元素的 **5**%。请参考以下 **灵敏度矩阵**。
 - 校准至关重要：灵敏度矩阵中的参数并非固有属性，而是必须通过校准测试确定，以校正特定设备的缺陷和安装方向。
 - 校正实际应用中的缺陷：灵敏度矩阵有助于补偿诸如安装错位和制造缺陷等因素，这些因素会导致传感器响应不理想。
 - 精度：通过使用灵敏度矩阵，可以更精确地将三轴加速度计的原始输出转换为特定坐标系中真实加速度矢量的精确测量值。


### 根据加速度计值估算 横滚角 $\theta_x$ 和 俯仰角 $\phi_y$


$$
\begin{bmatrix} a_{rx}  \\ a_{ry} \\ a_{rz}  \end{bmatrix} = \begin{bmatrix} -sin(\theta_x)  \\ cos(\theta_x) sin(\phi_y) \\ cos(\theta_x) cos(\phi_y) \end{bmatrix}
$$


$$
\theta_x = tan^{-1} \left ( \frac {a_{ry}} {a_{rz}} \right )
$$


$$
\phi_y= tan^{-1} \left ( \frac {-a_{rx}}{\sqrt{a_{ry}^2+a_{rz}^2}} \right )
$$

## 磁力计

同样也是辅助、校正陀螺仪，解决重力加速度无法检测到水平角度旋转的问题。磁力计或电子罗盘是用来测量磁场的元件，通常以高斯（Gauss）或特斯拉（Tesla）来表示磁场大小，因为地球本身存在磁场，所以磁力计可以藉由磁场在三轴上的投影来计算出航向角度，但事实上环境中的磁场不仅仅只有地球磁场，还包含了许多的干扰源，依特性可以分成硬磁（Hard Iron）干扰与软磁（Soft Iron）干扰，硬磁干扰是像永久磁铁、电池这些指固定强度的干扰，软磁干扰则是指像电磁铁、电量变化等，当磁力来源消失时，磁力会变弱，会改变磁力线强度或方向的干扰。

磁力計的簡單數學模型，磁力的輸出 $h_{measure}$ 會等於矩陣 $M_{mag}$ 乘上理想的磁場 $h_{real}$ 加上偏移 $h_{bias}$ 與雜訊 $n_{noise}$，矩陣 $M_{mag}$ 包含未對準的準誤、單位的轉換（gauss/LBS）、硬磁干擾、軟磁干擾，偏移 $h_{bias}$、雜訊 $n_{noise}$ 則也會由溫度、感測器內部等干擾引起

$$
h_{measure} = M_{mag} h_{real} + h_{bias} + n_{noise} 
$$

**高斯噪音（Gaussian Noise）下，平均值为 $n_{noise}=0$**

$$
h_{measure} = \begin{bmatrix} h_{x} \\ h_{y} \\ h_{z} \end{bmatrix} = \begin{bmatrix} M_{11} && M_{12} && M_{13} \\ M_{21} && M_{22} && M_{23} \\ M_{31} && M_{32} && M_{33} \end{bmatrix} \begin{bmatrix} h_{rx} \\ h_{ry} \\ h_{rz} \end{bmatrix} + \begin{bmatrix} b_{hx} \\ b_{hy} \\ b_{hz} \end{bmatrix} + \begin{bmatrix} 0 \\ 0 \\ 0 \end{bmatrix}
$$

$$
h_{real} = {M_{mag}}^{-1}(h_{measure} - h_{bias} - n_{noise})
$$

$$
h_{real} = \begin{bmatrix} h_{rx}  \\ h_{ry} \\ h_{rz} \end{bmatrix} = {\begin{bmatrix} M_{11} && M_{12} && M_{13} \\ M_{21} && M_{22} && M_{23} \\ M_{31} && M_{32} && M_{33} \end{bmatrix}}^{-1} \begin{bmatrix} h_{x} - b_{hx} - 0 \\ h_{y} - b_{hy} - 0 \\ h_{z} - b_{hz} - 0 \end{bmatrix}
$$

![Alt X](../assets/img/esp/magdistortion.png)

### 硬磁干扰

**硬磁干扰**指的是来自永久磁化物体的静止磁噪声问题，这种噪声会导致磁力计读数与真实原点存在偏差。这种效应会改变数据球的中心位置，是一种可以通过校准进行补偿的磁干扰，从而提高传感器读数的准确性。

 - 对数据的影响：在理想的、未经校准的情况下，旋转磁力计会产生以原点为中心的完美圆即一个三维球体。数据点：(0,0,0)。硬铁效应会使中心点偏离原点，但圆/球的形状保持不变。
 - 校准：为了校正硬铁失真，必须对传感器数据进行校准，使数据球的中心 **推回** 其原始位置。
 - 方法：通常的做法是将传感器旋转一周（360°），然后应用数学补偿来消除偏移。

一周（360°）后，在每個轴上取平均最大值，平均最少值。用以下公式计算出各轴的硬偏移量。


数学补偿来消除偏移的二维校准方法是將传感器旋转几个 360° 圆周来完成的，如果传感器在俯仰角和横滚角方向上的水平度保持在 5° 到 10° 之间，则通常足够。超出此范围，强烈建议进行完整的三维校准，这需要尽可能绕所有轴旋转传感器，以覆盖一个测量球面。

$$
各轴的硬偏移量校准 = \frac {各轴的平均最大值 + 各轴的平均最少值}{2}
$$


$$
灵敏度调整 = \frac {平均最大值-平均最少值}{IMU 分辨率}
$$

计算出的硬磁向量如下

$$
\begin{bmatrix} b_{hx}\\ b_{hy}\\ b_{hz}\end{bmatrix}
$$


### 软磁干扰

**软磁干扰**校正是指对软铁畸变进行校正或校准的过程。软铁畸变是由附近材料引起的磁场误差，这些材料会弯曲或扭曲局部磁场。这种畸变发生在磁导率高的材料中，例如铁和钢，需要复杂的校准才能校正，因为它们会将理想磁场测量形状从球形变为椭球形。软铁校正使用变换矩阵来补偿这些影响，从而恢复精确的磁场测量结果。

软磁干扰的成因：

 - 磁场弯曲：软铁材料会使周围的磁力线弯曲。
 - 灵敏度不均匀：这种弯曲会导致磁力计沿不同轴向的灵敏度不同。
 - 椭球形输出：综合来看，磁力计应该测量的理想球形磁场会畸变为椭球形。


软磁干扰校正的工作原理：

 - 数据采集：设备旋转至所有可能的方向，以采集各种磁场读数。
 - 数学变换：然后使用采集到的数据计算变换矩阵（“软铁矩阵”）。
 - 补偿：将该矩阵应用于磁力计的输出，以校正失真读数，将椭球体恢复为球体，从而提高精度。
 - 动态过程：如果设备环境发生变化，软铁矩阵也会发生变化，因此当设备移动或放置在新的磁源附近时，需要重新校准。

由于软铁矩阵是对称的，因此可得出计算出的软铁矩阵如下：

$$
{\begin{bmatrix} 
M_{11} && M_{12} && M_{13} \\ M_{21} && M_{22} && M_{23} \\ M_{31} && M_{32} && M_{33} \end{bmatrix}} = {\begin{bmatrix} 
M_{11} && M_{a} && M_{b} \\ M_{a} && M_{22} && M_{c} \\ M_{b} && M_{c} && M_{33} \end{bmatrix}}\\
\because M_{12} = M_{21}，M_{13} = M_{31}，M_{23} = M_{32}
$$

请参考：[最小平方法(伪逆)](https://hkdickyko.github.io/%E6%95%B0%E5%AD%A6/lsqsphere) 的 **<font color="#AA1000">球體计算部分</font>** 用作计算软铁矩阵的参数值。


### 利用磁力计估算 偏航角 $\psi_z$


根据加速度计的 横滚角 $\theta_x$ 及 俯仰角 $\phi_y$ 用以下公式计算出 


$$
\begin{bmatrix} h_{rx} \\ h_{ry} \\ h_{rz}  \end{bmatrix} = \begin{bmatrix} h_{rx}cos(\phi_y) + h_{ry}sin(\phi_y)sin(\theta_x) \cdot h_{rz}sin(\phi_y)cos(\theta_x) \\ h_{rx} cos(\theta_x) - h_{rz} sin(\theta_x) \\ -h_{rx}sin(\phi_y) + h_{ry}cos(\phi_y)sin(\theta_x) + h_{rz}cos(\phi_y)cos(\theta_x)  \end{bmatrix}
$$

$$
\psi_z = tan^{-1} \left ( \frac {h_{rx} cos(\theta_x) - h_{rz} sin(\theta_x)}{h_{rx}cos(\phi_y) + h_{ry}sin(\phi_y)sin(\theta_x) \cdot h_{rz}sin(\phi_y)cos(\theta_x)} \right )
$$

## 气压计

用作计算飞行器高度。氣壓計是用來測量氣壓的元件，通常使用帕（Pa）或百帕（hPa）來表示，一個大氣壓力大約是 <font color="#AA1000">$ P_r = 1013.25 hPa， \rho_0 = 1.293 kgm^{-3}，g = 9.81$</font>，大氣壓會隨著高度的提升而下降，其關係為每上升 9 米，大氣壓力降低 100 Pa，透過此關係可以使用氣壓計計算出目前的海拔高度，以目前 MEMS 氣壓計可以做到 1 Pa RMS 的高解析度情況下，大約可以檢測到 9 米的高度變化，但這都在是比較理想的情況下，實際上還會有空氣的流動、溫度與濕度的影響，使得計算、測量的誤差產生。


$$
\rho = \rho_0 \cdot \frac{P_i}{P_r} \cdot \frac {273.15 K}{T_i}
$$

$$
\Delta h = \frac {\Delta P}{-\rho g}
$$

通过测量获得 <font color="#AA1000">$P_i，T_i$</font>，<font color="#AA1000">$\rho，\Delta h$</font> 通过计算获得。

# 灵敏度矩阵

灵敏度矩阵是一个 3×3 矩阵，它既考虑了每个轴的主灵敏度，也考虑了 **交叉灵敏度**，即一个轴上的加速度会引起另一个轴上的输出。该矩阵对于精确测量至关重要，因为它能够补偿误差，例如由传感器未对准或缺陷引起的误差，从而更详细地了解设备的性能。矩阵参数通过校准测试确定，该测试测量传感器对已知输入加速度的响应。


如何利用重力计算灵敏度矩阵：

 - 重力投影：当加速度计静止时，它测量的是局部重力矢量近似为 1g。当加速度计倾斜时，其读数是该重力矢量在其敏感轴上的投影。
 - 灵敏度公式：沿该轴感应到的加速度大小由以下公式给出 $a=g⋅cos(\delta)$。
 - 当倾斜 45°：敏感轴倾斜角度为 45° 与垂直方向成一定角度时，灵敏度为
$cos(45°)≈0.707$ 这意味着加速度计的输出约为 0.707g。可参考以下 **静止下的合成 g 分量表**


![Alt X](../assets/img/3d/orientation.png)

下图是在静止下（仅存在 1g 的重力加速度），不同角度的加速度计，
  - 角度 1～8 的 Z 轴因为垂直于重力加速度，所以皆为 0g，
  - 角度 9~10 的 X， Y 轴因为垂直于重力加速度，所以皆为 0g。 
  - 角度 11 的 Y 轴因为垂直于重力加速度，所以皆为 0g。
  - 角度 12 的 X 轴因为垂直于重力加速度，所以皆为 0g。


![Alt X](../assets/img/3d/3d-axis.png)

## 静止下的合成 g 分量表

|ID|1|2|3|4|5|6|7|8|9|10|11|12|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|$\theta_x$|90|90|90|90|90|90|90|90|0|0|45|0|
|$\phi_y$|0|0|0|0|0|0|0|0|0|0|0|45|
|$\psi_z$|0|45|90|135|180|225|270|315|0|180|45|45|
|$g_x$|0|$\frac{1}{\sqrt{2}}$|1|$\frac{1}{\sqrt{2}}$|0|$\frac{-1}{\sqrt{2}}$|-1|$\frac{-1}{\sqrt{2}}$|0|0|$\frac{-1}{\sqrt{2}}$|0|
|$g_y$|1|$\frac{1}{\sqrt{2}}$|0|$\frac{-1}{\sqrt{2}}$|-1|$\frac{-1}{\sqrt{2}}$|0|$\frac{1}{\sqrt{2}}$|0|0|0|$\frac{-1}{\sqrt{2}}$|
|$g_z$|0|0|0|0|0|0|0|0|-1|1|$\frac{1}{\sqrt{2}}$|$\frac{1}{\sqrt{2}}$|

注意： Z 轴向上为 -g，这取决于使用芯片的设计。

$$
归纳出 → X = g_{sin(\theta)}, Y = g_{cos(\theta)} → \theta = atan(\frac{X}{Y})
$$

表示在 $Z$ 轴垂直于重力时，输出的 $X, Y$ 值相除，并取 $tan^{-1}$ 则可以得到倾斜角度，但需要注意的，这仅限于静止下，当有运动加速度的影响，得到的角度会是不准确的。

以下是一种校准低重力三轴 MEMS 加速度计的方法。该方法包括在 <font color="#FF1000">6</font> 个不同方向上进行测量，然后使用最小二乘法求解 <font color="#FF1000">12</font> 个校准参数。此校准方法可消除传感器的零重力偏差、轴间相互作用、灵敏度变化和封装错位等问题。

假设原始测量值（$r_x、r_y、r_z$）可以通过乘以一个 <font color="#FF1000">4×4</font> 矩阵转换为校准值（$C_x、C_y、C_z$）：

$$
\begin{bmatrix} C_x  \\ C_y \\ C_z \\ 1 \end{bmatrix} = 
\begin{bmatrix} a & b & c & j \\ d & e & f & k \\ g & h & i & l \\ 0 & 0 & 0 & 1 \end{bmatrix} \begin{bmatrix} r_x  \\ r_y \\ r_z \\ 1 \end{bmatrix}
$$

这是一个 3D 仿射变换，意味着它进行线性变换（旋转、剪切、缩放）和平移（偏移）。

校准参数 $a$ 至 $l$ 由最小二乘法确定：

$$
A x = b
$$

$$
x = (A^TA)^{-1} A^T b
$$

$A$：（$n×4$ 矩阵）在预定义方向上采集的原始测量数据

$$
A = \begin{bmatrix} 
A1_x & A1_y & A1_z & 1 \\
A2_x & A2_y & A2_z & 1 \\
A3_x & A3_y & A3_z & 1 \\
A4_x & A4_y & A4_z & 1 \\
. & . & . & 1 \\
. & . & . & 1 \\
. & . & . & 1 \\
An_x & An_y & An_z & 1 \\
\end{bmatrix}
\begin{matrix} 
 方向 1 \\
 方向 2 \\
 方向 3 \\
 方向 4 \\
 ... \\ 
 ... \\ 
 ... \\ 
 方向 n \\
\end{matrix}
$$

$x$：（$4×3$ 矩阵）校准参数（未知数）

$$
x = \begin{bmatrix} a & e & i \\ b & f & j \\ c & g & k \\ d & h & l \end{bmatrix}
$$

$b$：（$n×3$ 矩阵）$A$ 中每个方向所需的校准值

$$
b = \begin{bmatrix} 
b1_x & b1_y & b1_z \\
b2_x & b2_y & b2_z \\
b3_x & b3_y & b3_z \\
b4_x & b4_y & b4_z \\
. & . & . \\
. & . & . \\
. & . & . \\
bn_x & bn_y & bn_z \\
\end{bmatrix}
\begin{matrix} 
 方向 1 \\
 方向 2 \\
 方向 3 \\
 方向 4 \\
 ... \\ 
 ... \\ 
 ... \\ 
 方向 n \\
\end{matrix}
$$

线性变换有 9 个自由度，平移有 3 个自由度，因此总共有 12 个自由度（12 个参数：a 到 l）。因此，至少需要 12 个方程来求解这 12 个未知数。每个方向对应 3 个测量值（$x、y$ 和 $z$），所以设备至少需要处于 4 个不同的方向才能求解方程。

以下描述了六点校准方法：

- 在传感器 $+Z$ 轴向上时，采集 5 至 10 秒的原始数据。
- 对其他 5 个面重复此操作，并将结果记录在 $A$ 矩阵的每一行中。
- 利用以上公式，求解 $x$，其中 $b$ 的定义如下：

$$
b = \begin{bmatrix} 
1 & 0 & 0 \\
-1 & 0 & 0 \\
0 & 1 & 0 \\
0 & -1 & 0 \\
0 & 0 & 1 \\
0 & 0 & -1 \\
\end{bmatrix}
\begin{matrix} 
 X上 \\
 X下 \\
 Y上 \\
 Y下 \\
 Z上 \\ 
 Z下 \\ 
\end{matrix}
$$  

一旦确定了校准参数 $x$，就可以使用以上公式将原始测量值转换为校准参数。

$$
\begin{bmatrix} b_x \\ b_y \\ b_z \end{bmatrix} = \begin{bmatrix} A_x \\ A_y \\ A_z \end{bmatrix} x 
$$

其中 $\begin{bmatrix}A_x \\ A_y \\ A_z \end{bmatrix}$ 为原始测量值，$\begin{bmatrix}b_x \\ b_y \\ b_z\end{bmatrix}$ 为校准值。校准值的单位为 G。

## 校准方法的局限性

- 仅适用于低重力加速度计
    - 本方法以重力为参考，因此适用于低重力加速度计（约 3g），但不适用于高重力加速度计（约 200g）。校准高重力加速度计需要更大的受控加速度。
- 位置相关
    - 由于地球自转、海拔高度以及地球并非完美球体，地球表面重力变化约为 0.7%。例如：
      - 北极海平面：9.832 m/s²
      - 赤道附近乞力马扎罗山 5895 米峰顶：9.763 m/s²

    - 此处描述的校准方法会消除重力场的影响，并假设校准点的重力加速度为“1g”。但是，如果需要以 m/s² 为单位的绝对估计值，则必须记录校准点的重力场。然后，可以将该值乘以其他系数，从而将“1g”转换为m/s/s。
 - 温度依赖性
    - MEMS元件对温度变化非常敏感。实际应用中，每种可能出现的温度都需要校准参数。惯性测量单元（IMU）通常包含温度传感器，因此可以通过在两个或多个温度下进行校准，并将拟合的校准参数插值到实际温度，来扩展此技术以考虑温度依赖性。另请注意，同一产品的两个加速度计可能具有不同的温度特性。
  - 其他注意事项
    - 数值不稳定性
      - 求解最小二乘法涉及计算矩阵的逆。请检查行列式是否接近于零。
    - 异常值
      - 最小二乘法容易受到异常值的影响。请检测异常值并重新进行校准。
    - 振动
      - 加速度计是弹簧阻尼系统（欠阻尼二阶系统），具有固有频率和阻尼比。如果在共振附近存在持续振动（例如在无人机中），加速度计测量值可能会饱和。
    - 漂移
      - 这也被称为偏置不稳定性。即使设备处于静止状态且温度保持恒定，加速度计的值也会缓慢变化。这与积分漂移不同。漂移可以通过使用其他传感器（例如 GNSS）进行在线估计来校正。
    - IMU 位置
      - 如果加速度计的位置远离设备的重心，则其所感受到的加速度将与位于重心时不同。
    - 电路板上的力 
      - MEMS 元件对作用在电路板上的力非常敏感，例如悬空的连接器。
    - 有些 IMU 会在一段时间后停止响应，需要重置。这对于无人机等设备至关重要。