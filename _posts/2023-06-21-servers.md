---
category: [軟件]
tags: [系統, Linux]
title: 伺服器 Server
date: 2023-06-16 1:00:00
---

<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
    overflow:hidden;
  }
</style>



# 伺服器種類

 - 網頁伺服器 Web server
 - 網域名稱系統伺服器 DNS server
 - 網路位址轉譯伺服器 NAT server
 - 代理伺服器 Proxy server
 - 資料庫伺服器 Database server
 - 檔案伺服器 File server
 - 動態主機組態協定伺服器 DHCP server
 - 檔案傳輸協定伺服器 FTP server
 - 郵件伺服器 Mail server
 - 應用伺服器 Application server
 - 網路錄影伺服器 NVR Server
 - 遊戲伺服器


## 網頁伺服器安裝

```
$ sudo apt update
$ sudo apt install apache2
$ sudo systemctl enable apache2
$ sudo systemctl status apache2
```

### 服务器配置

- /etc/apache2：Apache <font color="#FF1000">配置文件</font>都驻留在此处。
- /etc/apache2/apache2.conf：主要配置文件。 修改它以更改<font color="#FF1000">全局配置</font>及加载配置目录中的其他文件。
- /etc/apache2/ports.conf：此文件指定<font color="#FF1000">侦听的端口</font>。 默认端口为 80，及 SSL 端口 443。
- /etc/apache2/sites-available/：可以存储每个站点虚拟主机的目录。不会使用此目录中找到的配置文件，除非它们链接到启用站点的目录。 通常，所有服务器块配置都在此目录中完成，然后通过使用 a2ensite 命令链接到其他目录来启用。
- /etc/apache2/sites-enabled/：存储已启用的每站点虚拟主机的目录。 通常，这些是通过使用 a2ensite 链接到站点可用目录中的配置文件来创建的。在启动或重新加载时读取此目录中的配置文件和链接以编译完整的配置。
- /etc/apache2/conf-available/ & /etc/apache2/conf-enabled/：这些目录与sites-available 和 sites-enabled 目录具有相同的关系，但用于存储不属于某个目录的配置片段。 虚拟主机。  conf-available 目录中的文件可以使用 a2enconf 命令启用，使用 a2disconf 命令禁用。
- /etc/apache2/mods-available/ &/etc/apache2/mods-enabled/：这些目录分别包含可用和启用的模块。 以 .load 结尾的文件包含加载特定模块的片段，而以 .conf 结尾的文件包含这些模块的配置。 可以使用 a2enmod 和 a2dismod 命令启用和禁用模块。


## 網域名稱系統伺服器安裝

```
$ sudo apt-get update
$ sudo apt-get install bind9
$ sudo apt-get install dnsutils
$ sudo systemctl enable bind9
```

### 本地 DNS 解析器的配置

- /etc/bind/：配置文件的目录
- named.conf：主要配置文件，包括其他三个文件的配置
   - /etc/bind/named.conf.options 添加递归语句中的 IP 地址替换为本地网络地址。
   - /etc/bind/named.conf.local
   - /etc/bind/named.conf.default-zones
 - db.127：localhost IPv4 反向映射区域文件
 - db.local：localhost 转发 IPv4 和 IPv6 映射区域文件
 - db.empty：空区域文件

#### named.conf.options

![bind9](../assets/img/linux/bind9.jpg)


## 網路位址轉譯伺服器安裝

```
$ sudo apt-get install iptables
$ sudo sysctl -w net.ipv4.ip_forward=1
$ sudo iptables -t nat -A POSTROUTING -o <外网接口> -j MASQUERADE
$ sudo sh -c "iptables-save > /etc/iptables.rules"
$ sudo systemctl enable iptables.service 
```
### 开机自动加载 iptables 规则

启动系统时自动加载 iptables 规则，可以通过以下步骤实现：

- 创建 /etc/network/if-pre-up.d/iptablesload 文件

```
$ sudo vi /etc/network/if-pre-up.d/iptablesload
```

- 添加以下内容到文件中并保存

```
#!/bin/bash
iptables-restore < /etc/iptables.rules
```

- 执行权限

```
$ sudo chmod +x /etc/network/if-pre-up.d/iptablesload
```

### 例子

```
# 定义变量
WAN_IF="ppp0"
WAN_IP="212.xx.99.22"
LAN_IF="eth0"
LAN_IP="192.168.100.0/24"

# iptables 是内核模块，必须先加载
modprobe ip_tables
modprobe iptable_nat
modprobe iptable_filter
modprobe iptable_mangle
modprobe iptable_raw
modprobe ipt_state
modprobe ipt_limit
modprobe ipt_LOG

# 選擇性模组
modprobe ipt_owner
modprobe ipt_REJECT
modprobe ipt_REDIRECT
modprobe ipt_MASQUERADE

# 加载追踪连线模组
modprobe ip_conntrack
modprobe ip_conntrack_ftp
modprobe ip_conntrack_irc

# 清除防火牆设置
iptables -F
iptables -X
iptables -Z
iptables -t nat -F
iptables -t nat -X
iptables -t nat -Z
iptables -t mangle -F
iptables -t mangle -X

# 刷新防火牆设置
iptables -P INPUT DROP
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -t nat -P PREROUTING ACCEPT
iptables -t nat -P POSTROUTING ACCEPT
iptables -t nat -P OUTPUT ACCEPT

# 接受来自 LOCALHOST 的连接 loopback
iptables -A INPUT -i lo -j ACCEPT

# 防火墙规则
iptables -A INPUT -m state --state NEW -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -m state --state NEW -p tcp -s 210.xx.33.99 --dport 21 -j ACCEPT

# NAT 来源设置
iptables -A INPUT -i $LAN_IF -j ACCEPT
echo "1" > /proc/sys/net/ipv4/ip_forward
iptables -A POSTROUTING -t nat -o $WAN_IF -s $LAN_IP -j SNAT --to $WAN_IP

# NAT 目标设置
iptables -t nat -A PREROUTING -p tcp -i ppp0 --dport 80 -j DNAT --to 192.168.100.104:80

# 接受来自 ESTABLISHED 和 RELATED 的连接
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```