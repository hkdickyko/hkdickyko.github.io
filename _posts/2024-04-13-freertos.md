---
category: [積體電路]
tags: [IoT, 3D]
title: FreeRTOS
date: 2024-04-13 12:33:36
---

# FreeRTOS

FreeRTOS 是一種適用於微型控制器的開放原始碼即時作業系統，可讓小型、低功率的邊緣裝置易於進行程式設計、部署、保護、連接及管理。 FreeRTOS 自由分散於MIT 開放原始碼授權下，包含一顆核心和一套不斷擴充的軟體程式庫，適用於各種產業和應用程式。

FreeRTOS 有四种状态，每种状态都有对应的状态链表管理。

![Alt x](../assets/img/iot/frtos.png)

- 运行态：占用CPU使用权时的状态。
- 就绪态：能够运行（没有被阻塞和挂起），但是当前没有运行的任务的状态。
- 阻塞态：由于等待信号量、消息队列、事件标志组、调用延迟函数等而处于的状态被称之为阻塞态。
- 挂起态：调用函数 vTaskSuspend() 对指定任务进行挂起，挂起后这个任务将不被执行。

调用函数 xTaskResume() 可退出挂起状态。

不可以指定超时周期事件（不可以通过设定超时事件而退出挂起状态）

## 创建任务

任务的创建有两种：

 - 静态内存任务
 - 动态内存任务

### 创建静态内存任务

xTaskCreateRestrictedStatic()

- 配置静态内存创建静态内存任务需要先实现以下内容：
    - 需要在  FreeRTOSConfig.h 打开 configSUPPORT_STATIC_ALLOCATION 宏，开启静态内存。
    
- 开启静态内存的同时需要实现两个函数：（使用静态内存分配任务堆栈和任务控制块内存）
     - vApplicationGetIdleTaskMemory()：空闲任务堆栈函数。
     - vApplicationGetTimerTaskMemory()：定时器任务堆栈函数。

注意静态内存对齐的配置在 portmacro.h 里面的 portBYTE_ALIGNMENT 宏，按自己需求配置即可。

在任务堆栈初始化时会把栈顶指针纠正为内存对齐。参考下列代码：

参考下列代码：

```c
pxTopOfStack = &(pxNewTCB->pxStack[ulStackDepth-(uint32_t) 1 ]);
pxTopOfStack = (StackType_t *) (((portPOINTER_SIZE_TYPE) pxTopOfStack) &
               (~((portPOINTER_SIZE_TYPE) portBYTE_ALIGNMENT_MASK)));
```

## 任务函数原型

```c
TaskHandle_t xTaskCreateStatic( // 返回任务句柄
     TaskFunction_t pxTaskCode, // 任务入口函数
     const char * const pcName, // 任务名称
     const uint32_t ulStackDepth, // 任务堆栈大小
     void * const pvParameters, // 传递给任务入口函数的参数
     UBaseType_t uxPriority, // 任务优先级
     StackType_t * const puxStackBuffer, // 任务堆栈
     StaticTask_t * const pxTaskBuffer) // 任务控制块
```

## 创建例子

```c
/* 创建静态内存任务 */
lzmStaticTestTaskHandle = xTaskCreateStatic(
   (TaskFunction_t) lzmStaticTestTask, // 任务入口函数
   (const char*) "lzm static test task", // 任务函数名                           
   (uint32_t) 256, // 任务堆栈大小                                           
   (void*) NULL, // 传递给任务入口函数的参数
   (UBaseType_t) 5, // 任务优先
   (StackType_t*) lzmStaticTestTaskStack, // 任务堆栈地址  
   (StaticTask_t* ) & lzmStaticTestTaskTCB); // 任务控制块地址   
                                    ```

### 创建动态内存任务

动态内存配置是在 FreeRTOSConfig.h 配置的，这些内存主要供给 FreeRTOS 动态内存分配函数使用。





