---
category: [編程]
tags: [Linux, IoT]
title: ESP 步进电动机
date: 2024-09-07 08:00:00
---
<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>

# 步进电动机介紹

步进电机的轴在通常相隔几度的离散旋转位置之间移动。由于这种精确的位置可控性，步进电机非常适合需要高定位精度的应用。

## 步进电动机特性

步进电机的行为与标准直流电机不同。每次移动一点点。步进电机在扭矩-速度关系上也不同于直流电机。

直流电机通常在没有齿轮机构的情况下，在低速下产生高扭矩的能力并不好。而步进电机的工作方式相反。它们在低速时产生最大的扭矩。

步进电机还有另一个特性，即**保持扭矩**，这是直流电机所没有的。保持扭矩使步进电机在不转动时能够牢牢保持其位置。这对于电机可能启动和停止的应用非常有用，而作用在电机上的力仍然存在。 这样就无需机械制动机制。

步进电机不仅仅**响应时钟信号**，它们还有多个绕组，需要按照正确的顺序通电后电机轴才会转动。颠倒顺序将导致电机反方向转动。如果控制信号发送顺序不正确，电机将无法正常转动。它可能只是嗡嗡作响而不转动。或者实际上会转动但不稳定。负责将步进和方向信号转换为绕组通电模式的电路称为转换器。大多数步进电机控制系统除了转换器之外还包含驱动器，以处理电机绕组所吸收的电流。

### 步进电动机运转速度

步进电机低速时可以正常运转,但若高于一定速度就无法启动,并伴有啸叫声。因为步进电机有一个技术参数：空载启动频率，即步进电机在空载情况下能够正常启动的脉冲频率，如果脉冲频率高于该值，电机不能正常启动，可能发生丢步或堵转。在有负载的情况下，启动频率应更低。如果要使电机达到高速转动，脉冲频率应该有加速过程，即启动频率较低，然后按一定加速度升到所希望的高频（电机转速从低速升到高速）。

### 步进电机精度

一般步进电机的精度为步进角的 **3-5** %，且不累积。

### 步进电机的外表温度

步进电机温度过高首先会使电机的磁性材料退磁，从而导致力矩下降乃至于失步，因此电机外表允许的最高温度应取决于不同电机磁性材料的退磁点；一般来讲，磁性材料的退磁点都在摄氏 **130** 度以上，有的甚至高达摄氏200度以
上，所以步进电机外表温度在摄氏 **80-90** 度完全正常。

### 步进电机的力矩会随转速的升高而下降

当步进电机转动时，电机各相绕组的电感将形成一个反向电动势；频率越高，反向电动势越大。在它的作用下，电机随频率（或速度）的增大而相电流减小，从而导致力矩下降。

### 克服两相混合式步进电机在低速运转时的振动和噪声

步进电机低速转动时振动和噪声大是其固有的缺点，可采用以下方案来克服：

- 如步进电机正好工作在共振区，可通过改变减速比等机械传动避开共振区；
- 采用带有细分功能的驱动器，这是最常用、最简便的方法；
- 换成步距角更小的步进电机，如三相或五相步进电机；
- 换成交流伺服电机，几乎可以完全克服震动和噪声，但成本较高；
- 在电机轴上加磁性阻尼器，市场上已有这种产品，但机械结构改变较大。

### 细分驱动器的细分数是否能代表精度

步进电机的细分技术实质上是一种电子阻尼技术，其主要目的是减弱或消除步进电机的低频振动，提高电机的运转精度只是细分技术的一个附带功能。比如对于步进角为 **1.8°** 的两相混合式步进电机，如果细分驱动器的细分数设置为 **4**，那么电机的运转分辨率为每个脉冲 **0.45°**，电机的精度能否达到或接近 **0.45°**，还取决于细分驱动器的细分电流控制精度等其它因素。不同的细分驱动器精度可能差别很大；细分数越大精度越难控制。

## 步进电机的类型

步进电机分为两个基本类别：

- 类型 <font color="#FF1000">永磁式</font> 步进一般为两相，转矩和体积较小，步进角一般为7.5度 或15度；
- 类型 <font color="#FF1000">混合式</font> 步进是指混合了永磁式和反应式的优点。它又分为两相和五相：两相步进角一般为 **1.8** 度而五相步进角一般为 **0.72**度。这种步进电机的应用最为广泛。

类型 <font color="#FF1000">反应式</font>步进已被淘汰一般为三相，可实现大转矩输出，步进角一般为1.5度，但噪声和振动都很大。

电机类型决定了驱动器类型和所用转换器的类型。这些类型包括单极、双极和多相。

## 每步度数

这通常是为特定应用选择步进电机时最重要的因素。该因素指定了轴每完整步进旋转的度数。电机的半步操作将使步数/转数加倍，并将每步度数减半。对于未标记的电机，通常可以手动仔细计算电机每转的步数。每步度数可以通过将 360 除以 1 完整旋转中的步数来计算。常见的<font color="#FF1000">度数/步数</font>包括：<font color="#FF1000">0.72、1.8、3.6、7.5、15</font> 甚至 <font color="#FF1000">90</font>。每步度数通常称为电机的分辨率。与未标记的电机一样，如果电机上只印有**步数/转数**，则将 <font color="#FF1000">360</font> 除以该数字将得出度数/步数值。

## 驱动序列永磁步进电机有几种子类型可供选择

### 标准驱动序列

![Alt steps1](../assets/img/esp/steps1.png)

电机每步都同时激活一个绕组。

### **高扭矩**和**半步**驱动序列

在高扭矩序列中，电机每步都同时激活两个绕组。这种双绕组组合产生的扭矩比标准序列高出约 1.5 倍，但消耗的电流是标准序列的两倍。

![Alt steps2](../assets/img/esp/steps2.png)

半步进是通过组合两个序列实现的。首先，激活其中一个绕组，然后激活两个绕组，然后激活一个绕组，等等。这实际上使电机轴每转一圈前进的步数加倍，并将每步的度数减半。

### 如何计算步进电机的步进延迟

- 将电机的 RPM 转换为 RPS

$$
RPS = \frac {RPM}{60}
$$

- 取倒数可得到每转秒数

$$
\frac {1}{RPS} = \frac {60}{RPM}
$$

- 除以 360 可得到每度秒数

$$
\frac {60}{RPM \times 360} = \frac {1}{6 \times RPM}
$$

- 乘以 1.8 可得到<font color="#FF1000">每步秒数</font>

$$
\frac {1.8}{6 \times RPM} = \frac {0.3}{RPM}
$$

## 28BYJ48步进马达+ULN2003驱动板

28BYJ-48 是 5V 单极步进电机，有五个端子。在这种电机中，脉冲频率决定了它的速度，以获得精确的速度调节。此外，脉冲序列决定了它的旋转方向，而脉冲数控制了它的转动距离。电机在大约 **15RPM** 的速度下可提供 **34.3mN.m** 的扭矩。它即使在静止状态下也能提供良好的扭矩，只要向电机供电就可以保持这种扭矩。唯一的缺点是它有点耗电，即使它不移动也会消耗电力。工作电流大约 **240mA**（典型）

注意，不能超过电机参数要求，如使用的电机（28BYJ-48）的参数：

- 最大空载牵出频率 > 900pps
- 最大空载牵入频率 > 500pps

也就是说空载转动时，最快的驱动拍频率最好不要超过 **900Hz**；空载启动时，最快的驱动拍频率最好不要超过**500Hz**，因为启动时初始转速从零开始，驱动拍太快的话会失步，可能无法转动起来。所以程序里也设计成了**500Hz**（2ms延时）一拍。

![Alt 28BYJ48](../assets/img/esp/28BYJ48.png)

### 单相激磁四拍 (标准驱动序列，一相激磁驅動法，一圈需要2048步)

最简单的步进电机驱动方式。电机在每个瞬间只有一个线圈导通，消耗电力小。但在切换瞬间时没有任何的电磁作用在转子上，容易造成振动，也容易因为惯性而失步。

> 马达步进角 **11.25**度 再乘以减速比得到输出的解析度：
>
>> 每步旋转 11.25 x 1/64 = 0.17578125 度
>>

若要转一圈，需要  360/0.17578125 = **2048**步

### 单双交替激磁八拍 (半步，優點：精度提升2倍，可高轉速)

使用单四拍和双四拍交替进行的方式，每传送一个励磁信号，步进电机前进半个步距角。其特点是分辨率高，运转更加平滑，是最常用的方式。

> 马达步进角 **5.625**度 再乘以减速比得到输出的解析度：
>
>> 每步旋转 5.625 x 1/64 = 0.087890625 度
>>

若要转一圈，需要  360/0.087890625 = **4096**步

### 双相激磁四拍 (高扭矩，優點：轉矩大 缺點：轉速慢、耗電)

这方式输出的转矩较大且振动较少，切换过程中至少有一个线圈通电作用于转子，使得输出的转矩较大，振动较小，也比单四拍平稳，不易失步。

> 马达步进角 **5.625**度 再乘以减速比得到输出的解析度：
>
>> 每步旋转 5.625 x 1/64 = 0.087890625 度
>>

若要转一圈，需要  360/0.087890625 = **4096**步

### 示例代码

#### steppers.h

![Alt stepperh](../assets/img/esp/stepperh.png)

#### steppers.c

![Alt steppers](../assets/img/esp/steppers.png)

#### main.c

![Alt steppersmain](../assets/img/esp/steppermotocmain.png)

## TB6600 驱动板

一款專業的兩相步進馬達驅動。可實現正反轉控制，

- 通過 **3** 位元撥碼開關選擇 **7** 檔細分控制 (<font color="#FF1000">1，2/A，2/B，4，8，16，32</font>)，
- 通過 **3** 位元撥碼開關選擇 **8** 檔電流控制（<font color="#FF1000">0.5，1，1.5，2，2.5，2.8，3.0，3.5</font>）A。

適合驅動 **57**、**42** 型兩相、四相混合式步進馬達。能達到低振動、小雜訊、高速度的效果驅動電機。

- 工作溫度 : -10～45℃
- 存放溫度 : -40℃～70℃
- 最大功耗 : 160W
- 峰值電流 : 4A
- 輸出電流	: 0.5-4.0A
- 供電電壓 : 9~42V 供電
- 控制電壓 : 3.3~24V

![Alt tb6600](../assets/img/esp/tb6600.png)

注意：每在引脚上发送脉冲时，都要等待一小段时间（让电机完成行程）。此处等待时间为 <font color="#FF1000">50 µs</font>。

![Alt tb6600](../assets/img/esp/tb6600set.png)

### 微步进设定

通过 SW1、SW2、SW3 设置脉冲模式（微步进模式），它决定了每个完整步骤将细分成多少微步。表示多少个脉冲为360°。选择合适的微步进设置。使运转在更精准和平滑。

### 额定电流设定

通过 SW4、SW5、SW6 设置步进电机的额定电流。步进电机的电流设置需要根据电机的额定电流选择合适的值。以避免电机过热或驱动器损坏。

### 共阴极与共阳极接法

在连接PUL、DIR和ENA引脚时，需选择使用共阴极接法还是共阳极接法：

- **共阴极接法**: PUL-、DIR-、ENA-全部接地（GND），而PUL+、DIR+、ENA+分别连接到ESP32的数字引脚。
- **共阳极接法**: PUL+、DIR+、ENA+全部连接到5V（对于ESP32），PUL-、DIR-、ENA-分别连接到ESP32的数字引脚。

共阴极接法更为常见，因为它通常与大多数微控制器的逻辑电平更兼容。<font color="#FF1000">以下使用的是共阴极接法</font>

#### 引脚的作用

- ENA（Enable）引脚用于使能或禁用驱动器：
  - 当**ENA**信号为低电平时，驱动器被使能，电机可以根据PUL和DIR信号正常运转。
  - 当**ENA**信号为高电平时，驱动器被禁用，电机不会响应PUL和DIR信号。
  - 可以用来在不需要时关闭电机，以节省电力或防止电机过热。   如设为始终使能驱动器，可以将 ENA+ 和 ENA- 直接连接到 GND。
- DIR（Direction）引脚的高低电平决定电机的顺时针或逆时针旋转。
- PUL（Pulse）引脚的脉冲信号，每个脉冲推动电机转动一步。再通过 SW1、SW2、SW3 设置脉冲模式。来决定电动机的转速。

## 步进马达 (17HS4401S)

- 电流: 直流1.5A/相
- 保持扭矩: ≥ 420mN.m
- 定位扭矩: 15mN.m REF
- 步距角: 1.8° ± 0.09°
- 最大空载启动频率: ≥ 1500 PPS
- 最大空载工作频率: ≥ 1900 PPS

### 最大空载 **启动频率** 及 **工作频率**

即步进电机在空载情况下能够正常启动的脉冲频率，如果脉冲频率高于该值，电机不能正常启动，因当步进电机转动时，电机各相绕组的电感将形成一个反向电动势；频率越高，反向电动势越大。在它的作用下，电机随频率(或速度)的增大而相电流减小，从而导致力矩下降。力矩不足够转动步进电机。

如在有负载的情况下，启动频率应更低。如要使电机达到高速转动，脉冲频率应该有加速过程，即启动频率较低，然后按一定加速度升到所希望的高频（电机转速从低速升到高速）。启动频率公式如下:

$$
启动频率 = 启动转速 × 每转多少步 = 启动转速 \times \frac {360}{步进角度}
$$

### 考虑减速器的计算

如需要减速器的总的输出

- 转矩是 **T**
- 转速是 **N**
- 减速比是 **5：1**
- 步进角度是 **A**

那么电机的转速是：**5N**，那么电机的输出转矩应该是 **T/5**，电机的工作频率应该是

$$
工作频率 = \color{red}{减速比} \times 启动转速 \times \frac {360}{步进角度} = 5 \times N \times \frac {360}{A}
$$

所以应该看矩频特性曲线：坐标点[转矩：T/5，脉冲频率：5xNx360/A]是不是在频特性曲线**自后动区域**內。如果是則可以选择这个电机，否则要选择其它型号，因为这个电机会失步，或者不能转动。

![Alt 矩频特性曲线](../assets/img/esp/speedregion.png)

补充：如工作状态及需要的最大转速确定。那可以根据上面的公式进行计算，(根据转动的最大速度，和负载的大小，就可以确定现在选用的步进电机是否适合，如不适合也应该知道要选用什么样的步进电机了)。

另外：步进电机在启动了以后，可以在负载不变的情况下，再提高频率，因为步进电机矩频曲线实际上应该有两条的，蓝色那条是最大空载启动频率曲线，红色那条是最大空载工作频率曲线，这条曲线代表的含义是：

- 启动完成以后可以增加负载，但电机不会失步；或者
- 启动完成以后在负载不变的情况下，可以适当增加运转速度，而电机不会失步。

关于步距角，比如说你是 A-B-C-D-A 单四拍控制，那么步距角就是一个 *A* 走过的角度，关于最大启动频率，其指的是 **A-B** 之间的间隔频率，手册里给的都是 > 于某个值，但是在实际应用时应该给的值就是最大值，

例如 最大空载启动频率 **> 250PPS**，在没有减速器的情况下。那么 **A** 到 **B** 之間的 **延迟秒数** 如下:

$$
间隔频率 = PPS = \frac {1}{延迟秒数} < 250, 延迟秒数 >= \color{red}{0.004s} = \color{red}{4ms}
$$

所以小于 **4ms** 就不足够扭矩转动电机。

### 扭矩

电机的动态力矩取决于电机运行时的平均电流（而非静态电流），平均电流越大，电机输出力矩越大，即电机的频率特性越硬。产生啸叫声可能是由于负载过大造成的，高速运转时电机的输出扭矩会下降，无法满足负载要求时电机发生堵转，并且啸叫声会随着频率的高低变化而变化，解决办法是降低转速或更换扭矩更大的电机。此外电机在高速运行停止后会出现短促的啸叫声，这是由对相电流进行斩波造成的，只需将步进驱动器面板上的自动半流设置为有效即可。

## FreeRTOS 的限制

由于 **FreeRTOS** 预设的 **portTICK_PERIOD_MS** 为 **100Hz** 即 <font color="#FF1000">100 PPS</font>，如果要比预设的运行速度更快的 **延迟秒数**，则需要更改 **CONFIG_FREERTOS_HZ** 参数，但该值最大只能改变为 **1kHz**。即 **延迟秒数** 最小为 <font color="#FF1000">1ms</font> 即 <font color="#FF1000">1000 PPS</font>。基于以上原因 vTaskDelay 只能用於最少为 1ms 的情况。

可以通过 **idf.py menuvonfig** 更改 FreeRTOS 的预设值如下图：

![Alt tb6600](../assets/img/esp/menuconfig.png)

可用 ROM 函数 **ets_delay_us()**（rom/ets_sys.h）将等待指定数量增至微秒级。

![Alt tb6600](../assets/img/esp/tb6600c.png)

## 解决方法

用定时器进入睡眠状态解决：
[ESP 定时器](https://hkdickyko.github.io/%E7%B7%A8%E7%A8%8B/sleep)

用远程控制收发器解决：
[ESP 远程控制收发器](https://hkdickyko.github.io/%E7%B7%A8%E7%A8%8B/RMT)