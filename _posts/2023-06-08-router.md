---
category: [軟件]
tags: [電腦]
title: Linux 路由器 
date: 2023-06-04 1:00:00
---

<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
    overflow:hidden;
  }
</style>

# 将 Linux 配置为路由器（IP 转发）


路由器是充当多个不同网络之间的中介的系统。 它接收来自一个网络的流量，这些流量最终发往另一个网络。 它能够识别特定数据包应该传送到哪里，然后通过适当的网络接口转发该数据包。

## 启用 IP 转发

 IP 转发在路由器上起着基础作用。 这是允许路由器将流量从一个网络接口转发到另一个网络接口的功能。 通过这种方式，它允许一个网络上的计算机访问不同网络上的计算机（当与路由软件一起配置时）。  IPv4 和 IPv6 地址的转发都在 Linux 内核中进行控制。 以下内核参数分别用于启用或禁用 IPv4 和 IPv6 转发。

IPv4：
```
$ net.ipv4.ip_forward
$ net.ipv4.conf.all.forwarding
```

IPv6：

```
net.ipv6.conf.all.forwarding
```

默认情况下，转发在大多数 Linux 系统上是禁用的。 要将 Linux 配置为路由器，需要启用它。 要启用转发，应将相应的参数设置为 1。值为 0 表示禁用转发。 要更新这些内核参数，请按以下步骤编辑 **/etc/sysctl.conf** 文件。

 在作路由器的 Linux 系统。 可以使用 SSH。确定当前是启用还是禁用 IPv4 转发。 下面的命令输出给定参数的值。 值 1 表示该设置已启用，而 0 表示它已禁用。 如果打算配置 IPv6 转发，请同时检查该内核参数。

```
$ sudo sysctl net.ipv4.ip_forward
```

如果此参数被禁用（或未处于所需状态），可续执行以下。使用编辑器（例如 vi）打开文件 **/etc/sysctl.conf**。

```
$ vi /etc/sysctl.conf
```

找到与启用的转发类型对应的行，取消注释并将值设置为 1。或者可以在文件中的任意位置添加这些行。

```
## Configure IPv4 forwarding
net.ipv4.ip_forward = 1

## Configure IPv6 forwarding
net.ipv6.conf.all.forwarding = 1
```

保存更改后，通过运行以下命令或重新启动计算机来应用更改。

```
$ sudo sysctl -p
```

## 配置 iptables

iptables 实用程序既可以用作防火墙（通过默认过滤表），也可以用作路由器（如使用 nat 表时）。 在此用 iptables 充当基本路由器。也可以使用任何其他防火墙或路由软件，例如 nftables 程序等。



登录到作路由器的 Linux 系统。 可以使用 SSH。查看现有的 iptables 规则。 如果您是全新安装的 Linux 并且没有任何预配置规则，则以下命令的输出应该为空。

```
$ iptables-save
```

可查找预期配置的任何规则。也可参与iptables 文档。或可刷新 iptables 规则并允许产生路由作用。

```
$ iptables -F
$ iptables -X
$ iptables -t nat -F
$ iptables -t nat -X
$ iptables -t mangle -F
$ iptables -t mangle -X
$ iptables -P INPUT ACCEPT
$ iptables -P OUTPUT ACCEPT
$ iptables -P FORWARD ACCEPT
```

接下来，在 iptables 上配置 NAT（网络地址转换）。 修改了网络数据包中的 IP 地址详细信息，允许专用网络上的所有系统共享路由器的相同公共 IP 地址。 添加以下 iptables 规则，将 10.0.2.0/24 替换为专用 VLAN 的子网。

```
$ iptables -t nat -s 10.0.2.0/24 -A POSTROUTING -j MASQUERADE
```

还可以放弃指定任何特定子网，并使用以下命令允许所有流量进行 NAT。

```
$ iptables -t nat -s 10.0.2.0/24 -A POSTROUTING -j MASQUERADE
```

还可以放弃指定任何特定子网，并使用以下命令允许所有流量进行 NAT。

```
$ iptables -t nat -A POSTROUTING -j MASQUERADE
```

 默认情况下，iptables 规则是临时的，如改持久化，可安装 iptables-persistent 软件包。 执行此操作时，系统启动时会加载保存在 **/etc/iptables/rules.v4**（以及 IPv6 的 rules.v6）中的规则。 也可以像往常一样继续对 iptables 进行更改。 当准备好保存时，将 iptables-save 的输出保存到 **/etc/iptables/rules.v4**（或 rules.v6）文件。 有关详细信息，请参阅使用 iptables 指南控制网络流量的相关部分。

``` 
$ iptables-save
$ sudo tee /etc/iptables/rules.v4
```

## 定义 Gateway

最后一步是手动调整除路由器之外的每个计算实例的网络配置设置。

 登录并部署每个非路由器计算实例禁用 Network Helper。 虽然 Network Helper 对于自动配置 VLAN IP 地址很有用，但现在需要手动编辑由 Network Helper 控制的配置文件。

 用 SSH 登录到未指定为路由器的每个 Linux 系统。编辑包含专用 VLAN 接口设置的配置文件。 此文件的名称和位置取决于使用的 Linux 发行版。对于在 Debian 10 上运行 ifupdown 的系统，网络配置通常存储在 **/etc/network/interfaces** 中。

```
$ sudo vi /etc/network/interfaces
```

在此文件中，调整为 VLAN 接口定义网关的参数。 该值应设置为分配给路由器 VLAN 接口的 IP 地址，例如 10.0.2.1，如果使用本示例。 对于在 Debian 10 上运行 ifupdown 的系统，可以在示例添加网关参数如下。


```
iface eth0 inet static address 10.0.2.2/24 gateway 10.0.2.1
```

保存这些设置后，重新启动计算实例或运行相应的命令以应用更改。 继续以 ifupdown 为例，运行以下命令作新的网络配置设置。

```
$ sudo ifdown eth0
$ sudo ip addr flush eth0
$ sudo ifup eth0
```








