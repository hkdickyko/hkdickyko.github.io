---
category: [編程]
tags: [IoT, 電子]
title: MD 图
date: 2025-04-06 1:00:00
---

<style>
  table {
    width: 100%
    }
  td.left {
    vertical-align: center;
    text-align: left;
  }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
  
</style>

<script src="../assets/plugin/mermaid.min.js"></script>


# Markdown 图

以下简写代表:

|简写|符号意义|
|:---:|:---:|
|W ->| 是写入|
|R <-|是读出|
|V|为数值|
|0x??|?? 为地址|
|>> ?|二進制位移後，? 为多少個位数|
|<< ?|二進制位移前，? 为多少個位数|
|t = ?|加計时器 ? 为延迟毫秒数|

---

<table><tr><th>目的</th><th>指令</th><th>读/写</th><th>库</th><th>代码</th><th>解释</th></tr>
<tr><td>设置设备库</td><td>REG_BANK_SEL<br>0x7F [5:4]</td><td>写入</td><td>-</td><td>0x7F, [0] << 4</td><td class="left">BANK : 0 | 1 | 2 | 3 选择用户库</td></tr>
<tr><td>读设备 ID</td><td>WHO_AM_I<br>0x00</td><td>读出</td><td>0</td><td>0x00</td><td class="left">指示正在访问哪个设备</td></tr>
<tr><td>重置设备</td><td>PWR_MGMT_1<br>0x06 [7]</td><td>写入</td><td>0</td><td>0x06, 0x80</td><td class="left">写入 1 即可设置复位</td></tr>
<tr><td>设时钟源</td><td>PWR_MGMT_1<br>0x06 [2:0]</td><td>写入</td><td>0</td><td>0x06, 0x01</td><td class="left">0 = 内部 20 MHz 振荡器<br>1-5 = 自动选择最佳可用时钟源<br>6 = 内部 20 MHz 振荡器<br>7 =停止时钟并</td></tr>
<tr><td>全开加速度计<br>和陀螺仪</td><td>PWR_MGMT_2<br>0x07 [5:0]</td><td>写入</td><td>0</td><td>0x07, 0x00</td><td class="left">0x00 全开<br>0x07 只开加速度<br>0x38 只开陀螺仪</td><td>
<tr><td>设置陀螺仪<br>采样率</td><td>GYRO_SMPLRT_DIV<br>0x00 [7:0] </td><td>写入</td><td>2</td><td>0x00, [7:0]</td><td class="left">此寄存器仅在 FCHOICE = 1'b1<br>(FCHOICE_B 寄存器位为 1'b0)<br>且 (0<DLPF_CFG<7) 时有效。<br>ODR (输出数据速率) 计算如下:<br>=$\frac{1100}{1+GYRO\_SMPLRT\_DIV}H_z$</td></tr>
<tr><td>陀螺仪<br>读写</td><td>GYRO_CONFIG_1<br>0x01 [0]</td><td>写入</td><td>2</td><td>0x01, [0]</td><td class="left">0 = 旁路<br>1 = 启用</td></tr>
<tr><td>陀螺仪<br>量程</td><td>GYRO_CONFIG_1<br>0x01 [2:1]</td><td>写入</td><td>2</td><td>0x01, [1:0] << 1</td><td class="left">00 = ±250 dps<br>01 = ±500 dps<br>10 = ±1000 dps<br>11 = ±2000 dps</td></tr>
<tr><td>陀螺仪<br>低通滤波器</td><td>GYRO_CONFIG_1<br>0x01 [5:3]</td><td>写入</td><td>2</td><td>0x01, [2:0] << 3</td><td><table><tr><thead><th>[2:0]</th><th>3dB带宽<br>Hz</th><th>NBW带宽<br>Hz</th></thead></tr><tbody><tr><td>0</td><td>196.6</td><td>229.8</td></tr><tr><td>1</td><td>151.8</td><td>187.6</td></tr><tr><td>2</td><td>119.5</td><td>154.3</td></tr><tr><td>3</td><td>51.2</td><td>73.3</td></tr><tr><td>4</td><td>23.9</td><td>35.9</td></tr><tr><td>5</td><td>11.6</td><td>17.8</td></tr><tr><td>6</td><td>5.7</td><td>8.9</td></tr><tr><td>7</td><td>361.4</td><td>376.5</td></tr></tbody></table>陀螺仪读写 GYRO_FCHOICE = 1</td></tr>
</td><td>速度计<br>采样率</td><td>ACCEL_SMPLRT_DIV_1<br>0x10 [3:0]<br>ACCEL_SMPLRT_DIV_2<br>0x11 [7:0]</td><td>写入</td><td>2</td><td>0x10, [3:0]<br>0x11 , [7:0]</td><td class="left">msb = 采样率分频器的 MSB (4位)<br>lsb = 采样率分频器的 LSB (8位)<br>ODR (输出数据速率) 计算如下:<br>= $\frac {1125}{1+ACCEL\_SMPLRT\_DIV[11:0]}H_z$</td></tr>
<tr><td>速度计<br>读写</td><td>ACCEL_CONFIG<br>0x14 [0]</td><td>写入</td><td>2</td><td>0x14, [0]</td><td class="left">0 = 旁路<br>1 = 启用</td></tr>
<tr><td>速度计<br>量程</td><td>ACCEL_CONFIG<br>0x14 [2:1]</td><td>写入</td><td>2</td><td>0x14, [1:0] << 1</td><td class="left">00 = ±2g<br>01 = ±4g<br>10 = ±8g<br>11 = ±16g</td></tr>
<tr><td>速度计<br>低通滤波器</td><td>ACCEL_CONFIG<br>0x14 [5:3]</td><td>写入</td><td>2</td><td>0x14, [2:0] << 3</td><td><table><th>[2:0]</th><th>3dB带宽<br>Hz</th><th>NBW带宽<br>Hz</th><tr><td>0</td><td>246.0</td><td>265.0</td></tr><tr><td>1</td><td>246.0</td><td>265.0</td></tr><tr><td>2</td><td>111.4</td><td>136.0</td></tr><tr><td>3</td><td>50.4</td><td>68.8</td></tr><tr><td>4</td><td>23.9</td><td>34.4</td></tr><tr><td>5</td><td>11.5</td><td>17.0</td></tr><tr><td>6</td><td>5.7</td><td>8.3</td></tr><tr><td>7</td><td>473</td><td>499</td></tr></table>速度计读写 ACCEL_FCHOICE = 1</td></tr>
<tr><td>中断设置</td><td>INT_PIN_CFG<br>0x0F [5]</td><td>写入</td><td>0</td><td>0x0F, [0] << 5</td><td class="left">1 – INT1 引脚电平保持，直到中断状态被清除<br>0 – INT1 引脚指示中断脉冲宽度为 50 µs</td></tr>
<tr><td>中断清除</td><td>INT_PIN_CFG<br>0x0F [4]</td><td>写入</td><td>0</td><td>0x0F, [0] << 4</td><td class="left">1 – 任何读取操作，INT_STATUS 中的中断状态将被清除
<br>0 – 仅读取 INT_STATUS 寄存器，INT_STATUS 中的中断状态才会被清除</td></tr>
<tr><td>设置 I2C 主时钟频率</td><td>I2C_MST_CTRL<br>0x01 [3:0]</td><td>写入</td><td>3</td><td>0x01, [3:0]</td><td><table><tr><th>[3:0]</th><th>时钟频率kHz</th><th>占空比</th></tr>
<tr><td>0</td><td>370.29</td><td>50.00%</td></tr>
<tr><td>1</td><td>-</td><td>-</td></tr>
<tr><td>2</td><td>370.29</td><td>50.00%</td></tr>
<tr><td>3</td><td>432.00</td><td>50.00%</td></tr>
<tr><td>4</td><td>370.29</td><td>42.86%</td></tr>
<tr><td>5</td><td>370.29</td><td>50.00%</td></tr>
<tr><td>6</td><td>345.60</td><td>40.00%</td></tr>
<tr><td>7</td><td>345.60</td><td>46.67%</td></tr>
<tr><td>8</td><td>304.94</td><td>47.06%</td></tr>
<tr><td>9</td><td>432.00</td><td>50.00%</td></tr>
<tr><td>10</td><td>432.00</td><td>41.67%</td></tr>
<tr><td>11</td><td>432.00</td><td>41.67%</td></tr>
<tr><td>12</td><td>471.27</td><td>45.45%</td></tr>
<tr><td>13</td><td>432.00</td><td>50.00%</td></tr>
<tr><td>14</td><td>345.60</td><td>46.67%</td></tr>
<tr><td>15</td><td>345.60</td><td>46.67%</td></tr></table></td></tr>
<tr><td>多主设备<br>设置</td><td>I2C_MST_CTRL<br>0x01 [7]</td><td>写入</td><td>3</td><td>0x01, [1] << 7</td><td class="left"> 1 = 启用多主设备功能<br> 0 = 禁用不使用 I2C_MST_IF 的时钟，并且禁用检测仲裁失败的逻辑</td></tr>
<tr><td>延迟数据<br>设置</td><td>I2C_MST_DELAY_CTRL<br>0x02 [0]</td><td>写入</td><td>3</td><td>0x02, [1]</td><td class ="left"> 1 = 仅访问从机 0，具体数量由 I2C_MST_ODR_CONFIG<br>决定1/个样本:(1+I2C_SLC4_DLY)</td></tr>
<tr><td>从机地址<br>设置</td><td>I2C_SLV0_ADDR<br>0x03 [7]</td><td>写入</td><td>3</td><td>0x03, [1] << 7</td><td class ="left">1 = 传输为读取<br>0 = 传输为写入</td></tr>
<tr><td>寄存器地址<br>设置</td><td>I2C_SLV0_REG<br>0x04 [7:0]</td><td>写入</td><td>3</td><td>0x04, [7:0]</td><td class ="left">设置从机 0 寄存器地址，从这传输数据</td></tr>

<tr><td>数据输出<br>设置</td><td>I2C_SLV0_DO<br>0x06 [7:0]</td><td>写入</td><td>3</td><td>0x06, [7:0]</td><td class ="left">当从机 0 设置为写入时，数据输出</td></tr>
</table>

---
|目的|指令|读/写|库|代码|解释|
|:---:|:---:|:---:|:---:|:---:|:---|
|数据输出<br>设置|I2C_SLV0_DO<br>0x06 [7:0]|写入|3|0x06, [7:0]|当从机 0 设置为写入时，数据输出。|

self.bank(3)


self.write(ICM20948_I2C_SLV0_DO, 0xff)
self.write(ICM20948_I2C_SLV0_CTRL, 0x80 | 1)  # Read 1 byte




<div class="mermaid">
sequenceDiagram;
   autonumber;
   participant C as Control; 
   participant I as ICM20948;
   participant A as AK09916;
   note over C,I: set bank V = 0;
   C->>I: W -> 0x7F, V << 4;
   note over C,I: WHO_AM_I = 0x00;
   I-->>C: R <- 0x00;
   note over C,I: reset;
   note over C,I: PWR_MGMT_1 = 1
   C->>I: W -> 0x06, V = 0x00;
   I-->>C: t = 10;
   note over C,I: set clock;
   C->>I: W -> 0x06, V = 0x01;
   note over C, I: set Acc & Gyro ON;
   C->>I: W -> 0x07, V = 0x00;
   alt;
   note over C,I:set bank V = 2;
   C->>I: W -> 0x7F, V << 4;   
   else;
   note over C, I: set Gyro sample rate   
   note over C, I: V = 1.1 kHz/(1+GYRO_SMPLRT_DIV[7:0]);
   C->>I: W -> 0x00, V;
   end;
   alt;
   note over C,I:set bank V = 2;
   C->>I: W -> 0x7F, V << 4;   
   else; 
   note over C,I: set Gyro LowPass filter;
   note over C,I: get current setting;
   I-->>C: R = (R <- 0x01) & 0b10001110;
   note over C,I: enable DLPF;
   C->>I: W-> R | 0x01;
   note over C,I: 250,  500, 1000, 2000;
   note over C,I:0b00, 0b01, 0b10, 0b11;
   note over C,I:V = 0b00 << 1 at 250;
   I-->>C: V =  V << 4;
   note over C,I: ICM20948_GYRO_CONFIG_1 = 0x00;  
   C->>I: W -> 0x01, V;
   end;
   alt;
   note over C,I: set bank V = 2;
   C->>I: W -> 0x7F, V << 4;
   else;
   note over C, I: set Gyro scale;
   I-->>C: R = (R <- 0x01) & 0b11111001; 
   note over C,I: 250,  500, 1000, 2000;
   note over C,I:0b00, 0b01, 0b10, 0b11;
   note over C,I:V = 0b00 << 1 at 250;
   note over C,I: ICM20948_GYRO_CONFIG_1 = 0x00;
   C->>I: W -> 0x01, V;
   end
</div>