---
category: [Movies]
tags: [系統, Linux]
title: ffmpeg 應用
date: 2023-06-26 1:00:00
---

<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>


# 前言

FFmpeg 是一个完整的跨平台音视频解决方案，它可以用于处理音频和视频的转码、录制、流化处理等应用场景。

官网：http://ffmpeg.org/

FFmpeg 有三大利器，分别是 

- **ffmpeg** 主要是多媒体的编解码工具，具体功能主要包括视频裁剪，去除水印，添加 logo，提取封面，提取音频，提取视频等功能。
   - ffmpeg的主要工作流程相对比较简单如下
![image](ffmpeg (20230921113357).png)

   - 其中需要经过六个步骤，
      - ffmpeg 首先读取输入源
      - 用 Demuxer 将音视频包进行解封装
      - 通过 Decoder 进行解码，将音视频通过Decoder 解码成为 YUV 或者 PCM 数据
      - 再通过 Encoder 将对应的数据进行编码  
      - 将编码后的音视频数据包通过 Muxer 进行封装
      - 最终输出为输出流

- **ffprobe** 是多媒体分析工具，比如音视频的参数、媒体容器的参数信息等。也可以分析媒体文件中每个包的长度、包的类型、帧的信息等。
- **ffplay** 提供了音视频显示和播放相关的图像信息，音频的波形信息等。简而言之就是一个播放器。
 
# ffmpeg-python

## 字幕样式

要改变字幕样式的外观，需要考虑包括应该支持字幕的内容、时间性和外观细节的文本文件。
给出了详细的出现顺序、时间和字幕内容。指定有关字幕外观的任何细节。要更改字幕的外观，需要通过添加新属性来修改此文本文件。

### 字幕外观的属性列表

**Font**

  - FontName：字体名称（例如 Arial、Times New Roman 等）
 
**Fontsize**

 - Fontsize：字体大小（例如 20 表示 20 点字体大小）

**Color**

 - PrimaColour：字幕的 Prima 颜色，例如，“&H00FFFFFF”表示 ABGR 格式中的白色
 - OutlineColour：文本轮廓颜色，例如 “&H80000000” 表示 ABGR 格式的半透明轮廓
 - BackColour：字幕背景颜色，例如 “&H40000000” 表示半透明 ABGR 格式的背景

**Text style**

 - Bold：使文本变为粗体（1 为启用，0 为禁用） 
 - Italic：使文本变为斜体（1 为启用，0 为禁用） 
 - Underline：为文本添加下划线（1 为激活，0 为停用） 
 - StrikeOut：删除文本（1 为激活，0 禁用）

**Borders**

 - Outline：文本轮廓厚度（例如 2 表示 2 像素轮廓）
 - BorderStyle：边框样式（0为无边框，1为单边框）
 
**Alignment**

 - Alignment：字幕的水平对齐方式（例如2为中心，7为屏幕底部）
 
**Spacing**

 - MarginL、MarginR、MarginV：左、右和垂直文本边距（例如 20 表示 20
 像素）


## 字幕样式例子

```
import ffmpeg

videoSrc = "video.mp4"
audioSrc = "audio.mp3"
outFile = "output.mp4"
srtFile = "source.srt"

style="FontName=Roboto,Bold=1,Italic=0,Fontsize=10,PrimaryColour=&H00ff3333,OutlineColour=&H20ffffff,Outline=1,BorderStyle=1"
        
input_video = ffmpeg.input(videoSrc)
input_audio = ffmpeg.input(audioSrc)
out = (ffmpeg.concat(input_video, input_audio, v=1, a=1)
       .filter('crop', w=300, h=300, x=0, y=0)
       .filter("subtitles", srtFileName, force_style=style)
       .output(outFile, vcodec='libx264', crf=iCRF, loglevel="error")
       )
ffmpeg.run(out, overwrite_output=True)
```

concat 将视频和音频合并到一个文件，参数
 - n 例子中没有显示，n 默认为 2。 
 - v 表示视频：将存储在第 1 部分，默认为 1。
 - a 表示音频：将存储在第 1 部分，默认为 0。 即音频将存储在每个视频流中。


crop 过滤器将视频裁剪或调整为任意尺寸并删除无水印的黑色边框，
 - w 表示宽度
 - h 表示高度
 - x 表示左侧
 - y 表示顶部
 
如果不设置 x 和 y ，则参考位于视频流的中央

CRF (恒定速率因子) 的范围是 0-51，其中 0 是无损的仅适用于8位，10位使用-qp 0，23 是默认值，51 是可能的最差质量。 一般较低的值会带来更高的质量，合理的范围是 17-28。17 或 18 在视觉上是无损的；它看起来应该与输入相同或几乎相同，但事实并非如此只是技术上无损。


## 常用函数
- compile()：编译二进制文件。
- get_ffmpeg_version()：获取FFmpeg版本号。
- get_ffprobe_version()：获取FFprobe版本号。
- get_platform()：获取平台信息。
- get_available_filters()：获取可用的过滤器列表。
- get_available_formats()：获取可用的媒体格式列表。
- input()：指定输入文件或视频流。
- output()：指定输出文件或视频流。
- run()：运行命令进行转码处理。
- filter()：为指定的输入或输出添加过滤器。
- overlay()：将视频叠加到另一个视频上。
- concat()：将多个视频合并。
- split()：将视频拆分成多个片段。
- trim()：裁剪输入视频的指定部分。
- setpts()：调整视频帧速率。
- drawtext()：在视频中添加文本。
- scale()：调整视频大小和比例。
- pad()：调整视频的宽度和高度。
- hflip()：水平翻转视频。
- vflip()：垂直翻转视频。
- transpose()：旋转90度，逆时针或顺时针旋转。
- autorotate()：根据元数据自动旋转视频。
- mute()：去除音频轨道。
- audio：指定音频参数，如采样率、声道数等。
- video：指定视频参数，如帧率、像素格式等。


## 其它

- ffmpeg.get_ffmpeg_version()：获取FFmpeg的版本号
- ffmpeg.get_ffprobe_version()：获取FFprobe的版本号
- ffmpeg.get_media_info(filename)：获取媒体文件的信息，包括时长、码率、分辨率等
- ffmpeg.get_thumbnail(filename, time, output_path)：获取视频文件指定时间的缩略图
- ffmpeg.get_video_thumbnail(filename, time, output_path)：获取视频文件指定时间的视频缩略图
- ffmpeg.get_audio_thumbnail(filename, time, output_path)：获取音频文件指定时间的音频波形图
- ffmpeg.convert(input_path, output_path, options)：将媒体文件转换为指定格式，可以指定多种转换选项
- ffmpeg.trim(input_path, output_path, start_time, duration)：剪辑媒体文件，可以指定剪辑起始时间和持续时间
- ffmpeg.concat(input_paths, output_path)：将多个媒体文件拼接成一个文件
- ffmpeg.overlay_video(overlay_path, base_path, output_path, options)：将视频文件叠加到另一个视频文件上
- ffmpeg.overlay_audio(overlay_path, base_path, output_path, options)：将音频文件叠加到另一个音频文件上
- ffmpeg.add_watermark(input_path, output_path, watermark_path, options)：给视频文件添加水印
- ffmpeg.extract_audio(input_path, output_path, options)：从视频文件中提取音频
- ffmpeg.extract_video(input_path, output_path, options)：从视频文件中提取视频
- ffmpeg.extract_subtitle(input_path, output_path, options)：从视频文件中提取字幕
- ffmpeg.extract_frame(input_path, output_path, time, options)：从视频文件中提取指定时间的帧
- ffmpeg.add_subtitle(input_path, output_path, subtitle_path, options)：给视频文件添加字幕
- ffmpeg.add_audio(input_path, output_path, audio_path, options)：给视频文件添加音频
- ffmpeg.add_video(input_path, output_path, video_path, options)：给音频文件添加视频
- ffmpeg.add_effect(input_path, output_path, effect_name, options)：给媒体文件添加特效


## 基础用法例子

使用 FFmpeg-python 裁剪视频文件的前10秒钟

```
import ffmpeg
input_file = 'input.mp4'
output_file = 'output.mp4'
# 裁剪前十秒
ffmpeg.input(input_file).trim(start=0, duration=10).output(output_file).run()
```