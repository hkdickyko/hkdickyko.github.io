---
category: [MPU]
tags: [IoT, 编程, 数学]
title: IMU 姿态计算方法
date: 2025-11-16 12:00:00
---

<style>
  table {
    width: 100%
    }
  td.left {
    vertical-align: center;
    text-align: left;
    width: 30%;
  }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  tr:nth-child(even){
    background-color:#ffffe5;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>

# IMU 姿态计算方法

就文章 [惯性测量传感器 IMU 详解](https://hkdickyko.github.io/mpu/imu-detail) 内容加上姿态融洽计算方法。便可直接用计算方法计算出传感器测出三维空间上的移动轨迹。

以三轴陀螺仪、三轴加速度计、三轴磁力计和气压计做说明，首先要先了解三轴之间的关系，假设有三个向量 $X、Y、Z$，其方向分别为三个轴的方向，那这三个向量会互相垂直、正交（Orthogonality），也就像是 $X \cdot Y = 0$ 或 $X \otimes Y = Z$。可用右手定则来了解。

罗德里格旋转是指计算三维空间中一个向量绕指定旋转轴旋转给定角度后的新向量的公式。它在原文中被用来推导四元数表示旋转的定理。具体来说，罗德里格旋转公式是：

基本公式

$$
v{'} = v \cos \theta + (u \otimes v) \sin \theta + u(u \cdot v)(1 - \cos \theta)
$$

分项解释

|符号|解释|
|:---:|:---:|
|$v^{'}$ | 旋转后的新向量|
|$v$ | 原始向量|
|$u$ | 单位旋转轴向量|
|$\theta$ | 旋转角度|
|$\otimes$ | 叉乘（向量积）|
|$\cdot$ | 点乘（点积）|

这个公式利用了原始向量、旋转轴和它们的叉积来表示旋转后的新向量。在原文中，它被用来通过四元数乘法来实现向量的旋转。

四元数 ： $ q = [q_w， q_x，q_y，q_z] $ 在 NED - Z-Y-X 系统。

任意向量 $v$ 绕着以单位向量定义的旋转轴 $u$ 旋转 $\theta$ 度后的 $v^{'}$ 可以使用四元数乘法来获得四元数旋转公式：

$$
v^{'} = q v q^{*} = q v q^{-1}
$$

$$
q_w = cos\left(\frac{\theta}{2}\right)，
q_x = sin\left(\frac{\theta}{2}\right)u_x，
q_y = sin\left(\frac{\theta}{2}\right)u_y，
q_z = sin\left(\frac{\theta}{2}\right)u_z
$$

$$
q = \begin{bmatrix} cos\left(\frac{\theta}{2}\right)，sin\left(\frac{\theta}{2}\right) \cdot \begin{bmatrix}u_x \\ u_y \\ u_z\end{bmatrix} \end{bmatrix}
$$

从大地坐标系 $R$ 转换到机体坐标系 $b$ 的姿态矩阵为：

$$
C_R^b = \begin{bmatrix}
q_w^2 \color{red}{+ q_x^2} - q_y^2 - q_z^2 & 2(q_xq_y + q_wq_z) & 2(q_xq_z - q_wq_y) \\
2(q_xq_y - q_wq_z) &  q_w^2 - q_x^2 \color{red}{+ q_y^2} - q_z^2 & 2(q_yq_z + q_wq_x) \\
2(q_xq_z + q_wq_y) & 2(q_yq_z - q_wq_x) &  q_w^2 - q_x^2 - q_y^2 \color{red}{+ q_z^2}
\end{bmatrix}
$$

从机体坐标系 $b$ 到大地坐标系 $R$ 的姿态矩阵为：

$$
C_b^R = \begin{bmatrix}
 q_w^2 \color{red}{+ q_x^2} - q_y^2 - q_z^2 & 2(q_xq_y \color{orange}{-} q_wq_z) & 2(q_xq_z \color{orange}{+} q_wq_y) \\
2(q_xq_y \color{orange}{+} q_wq_z) &  q_w^2 - q_x^2 \color{red}{+ q_y^2} - q_z^2 & 2(q_yq_z \color{orange}{-} q_wq_x) \\
2(q_xq_z \color{orange}{-} q_wq_y) & 2(q_yq_z \color{orange}{+} q_wq_x) &  q_w^2 - q_x^2 - q_y^2 \color{red}{+ q_z^2}
\end{bmatrix}
$$

详细可参考 [DCM 方向余弦矩阵](https://hkdickyko.github.io/mpu/dcm-info)

其中从 **NED** Z-Y-X 坐标系的欧拉角如下：

$$
C = \begin{bmatrix}
C_{11} & C_{12} & C_{13}\\
C_{21} & C_{22} & C_{23}\\
C_{31} & C_{32} & C_{33}
\end{bmatrix}
$$

通过四元数的值反解出机体坐标系的欧拉角

$$
\begin{bmatrix} roll_x \\ pitch_y \\ ya\omega_z \\ \end{bmatrix} = \begin{bmatrix} \theta_x \\ \phi_y \\ \psi_z \\ \end{bmatrix} = \begin{bmatrix} 
\operatorname{atan2}(C_{32}, C_{33}) \\
\operatorname{asin}(-C_{31}) \\
\operatorname{atan2}(C_{21}, C_{11}) \\ 
\end{bmatrix}
$$

四元数对时间 $t$ 用欧拉法更新形式进行微分，可得以下公式：

$$
\frac{dQ}{dt} = \frac {1}{2}\begin{bmatrix}
0 & -\omega_x & -\omega_y & -\omega_z \\
\omega_x & 0 & \omega_z & -\omega_y \\
\omega_y & -\omega_z & 0 & \omega_x \\
\omega_z & \omega_y & -\omega_x & 0
\end{bmatrix} \cdot \begin{bmatrix} q_w \\ q_x \\ q_y \\ q_z \end{bmatrix}
$$

求解该微分方程即可得到当前四元数的值。但计算机中的计算是离散的，所以我们需要对该微分方程进行离散化处理，这样才可以有效的通过单片机或其他数字控制器进行求解：

$$
\begin{bmatrix}q_w \\ q_x \\ q_y \\ q_z \end{bmatrix}_{t+\Delta t} = \begin{bmatrix}q_w \\ q_x \\ q_y \\ q_z \end{bmatrix}_{t} + \frac {\Delta t}{2}\begin{bmatrix}
-\omega_x q_x - \omega_y q_y - \omega_zq_z \\
\omega_x q_w - \omega_y q_z + \omega_zq_y \\
\omega_x q_z + \omega_y q_w - \omega_zq_x \\
-\omega_x q_y + \omega_y q_x + \omega_zq_w
\end{bmatrix}
$$


## 传感器数据融合

对于六轴数据，计算角度有两种方法：

 - 通过对角速度积分得到角度
    - 通过角速度积分得到角度时，角速度的误差会在积分过程中被不断放大从而影响数据准确性存在**结果偏差**。
 - 通过对加速度进行正交分解得到角度
    - 而加速度计是一种特别敏感的传感器，电机旋转产生的震动会给加速度计的数据中带来**高频噪声**。


![Alt X](../assets/img/3d/DCM.png)


### 加速度进行正交分解

**地球引力的方向大致指向地心**，在局部尺度上，引力指向质心。设有大地坐标下的重力加速度 $g$，把 $g$ 通过姿态矩阵（坐标转换矩阵）的逆（意味着从地理坐标系 $R$ 到机体坐标 $b$ 系）变换到机体坐标系，得到其在机体坐标系下的 **理论重力加速度向量 $\hat{g}$**，则两者的变换关系可通过前文给出的姿态矩阵得出：

归一化大地坐标的重力加速度 $g_R$

$$
g_R = \begin{bmatrix} 0 \\ 0 \\ 9.81\end{bmatrix}, \hat{g_R} = \begin{bmatrix} 0 \\ 0 \\ 1\end{bmatrix}
$$

$$
\hat{g} = \begin{bmatrix} \hat{g_{x}} \\ \hat{g_{y}} \\ \hat{g_{z}}\end{bmatrix} = C_b^R \cdot \hat{g_R} \Rightarrow C_b^R \cdot \begin{bmatrix} 0 \\ 0 \\ 1\end{bmatrix} = \begin{bmatrix}
2(q_xq_z + q_wq_y) \\
2(q_yq_z - q_wq_x) \\
q_w^2 - q_x^2 - q_y^2 + q_z^2
\end{bmatrix}
$$


可以看出，将重力加速度向量变换至机体坐标系后，恰好是矩阵的最后一列。这样就得到了由描述刚体姿态的四元数推导出的<font color="#FF1000">理论重力加速度向量</font> $\hat{g}$。还可以通过加速度计<font color="#FF1000">测量重力加速度向量</font> $\hat{a}$。

显然理论重力加速度向量 $\hat{g}$ 和实际重力加速度向量 $\hat{a}$ 之间必然存在偏差，而这个偏差很大程度上是由陀螺仪数据产生的角速度误差引起，根据理论向量和实际向量间的偏差，就可以补偿陀螺仪数据的误差，进而解算出较为准确的姿态，即将隐含在四元数中的角速度误差显化。

单位四元数的定义即是模为 1 的四元数： 

$$
|q|=\sqrt{q_w^2+q_x^2+q_y^2+q_z^2}=1
$$

$$
\because -q_x^2-q_y^2 = \color{red}{q_w^2+q_z^2-1} \\
q_w^2\color{red}{-q_x^2-q_y^2}+q_z^2 \Rightarrow  q_w^2+q_w^2+q_z^2-1+q_z^2
$$

$$
\therefore q_w^2-q_x^2-q_y^2+q_z^2 = 2(q_w^2+q_z^2-0.5)
$$

$$
\because q_w^2+q_z^2 = \color{red}{-q_x^2-q_y^2 +1}  \\
\color{red}{q_w^2}-q_x^2-q_y^2+\color{red}{q_z^2} \Rightarrow -q_x^2-q_y^2 +1 -q_x^2-q_y^2
$$

$$
\therefore q_w^2-q_x^2-q_y^2+q_z^2 = 2(0.5-q_x^2-q_y^2)\\ 
$$

估计重力方向和垂直于磁通量的矢量


$$
\begin{bmatrix} \hat{g_x} \\ \hat{g_y} \\ \hat{g_z} \end{bmatrix} = 
\begin{bmatrix}
q_w^2 \color{red}{+ q_x^2} - q_y^2 - q_z^2 & 2(q_xq_y \color{orange}{-} q_wq_z) & 2(q_xq_z \color{orange}{+} q_wq_y) \\
2(q_xq_y \color{orange}{+} q_wq_z) &  q_w^2 - q_x^2 \color{red}{+ q_y^2} - q_z^2 & 2(q_yq_z \color{orange}{-} q_wq_x) \\
2(q_xq_z \color{orange}{-} q_wq_y) & 2(q_yq_z \color{orange}{+} q_wq_x) &  q_w^2 - q_x^2 - q_y^2 \color{red}{+ q_z^2}
\end{bmatrix} \cdot \begin{bmatrix} 0 \\ 0 \\ 1 \end{bmatrix}
$$

$$
\hat{g_x} = 2(q_xq_z + q_wq_y)\\
\hat{g_y} = 2(q_yq_z - q_wq_x)\\
\hat{g_z} = 2(q_w^2+q_z^2-0.5)
$$

$\hat{g_x}、\hat{g_y}、\hat{g_z}$ ，其实是用上一次机体姿态（四元数）换算出来的在当前的机体坐标系上的重力单位向量。


对测量重力加速度向量 $a_r$ 与理论重力加速度向量 $\hat{g}$ 做叉积其结果必然为零，因为加速度和重力向量是平行向量。而<font color="#AA1000">任意两个平行或反平行向量的 $\otimes$ 叉积 (Cross product) 始终为零</font>。



$$
a_r \otimes \hat{g} = \begin{bmatrix} 
\hat {i} & \hat {j} & \hat {k} \\
a_{rx} & a_{ry} & a_{rz} \\ 
\hat{g_x} & \hat{g_y} & \hat{g_z} \end{bmatrix}
$$

可参考 [向量](https://hkdickyko.github.io/%E6%95%B0%E5%AD%A6/vector) 解说


$$
e_x = a_{ry} \hat{g_z} - a_{rz} \hat{g_y}， \\
e_y = a_{rz} \hat{g_x} - a_{rx} \hat{g_z}， \\
e_z = a_{rx} \hat{g_y} - a_{ry} \hat{g_x}， $$

因为加速度和重力向量的和必然为零，所以计算后 $e_x、e_y、e_z$ 为计算误差的数值。基于以上计算结果，可以用 PID 数学补偿方法来修正误差值。使计算值尽量接近零，用以已修正测量误差。[PID数学补偿方法](https://hkdickyko.github.io/mpu/pid)


IMU 的基本 PID（比例-积分-微分）控制方程由三个项组成，它根据期望状态和当前 IMU 读数之间的误差来计算控制输出。该输出的计算方法如下：


$$
\bar{E_r} = \left ( K_p \times E_r \right) + \left(K_i \times \int E_r \cdot dt \right) + \left(K_d \times \frac {dE_r}{dt} \right)，E_r : 误差
$$


$$
\bar{E_r} = \left ( K_p \times E_r \right) + \left(K_i \times \int E_r \cdot \Delta t \right) + \left(K_d \times \frac {E_r(t) - E_r(t-1) }{\Delta t} \right)
$$


$$
\begin{bmatrix} \bar{e_x} \\ \bar{e_y} \\ \bar{e_z} \end{bmatrix} = K_p \times \begin{bmatrix} e_x \\ e_y \\ e_z \end{bmatrix} + K_i \times \int \begin{bmatrix} e_x \\ e_y \\ e_z \end{bmatrix} \cdot \Delta t + K_d \times \frac {1}{\Delta t} \cdot \left ( \begin{bmatrix} e_x \\ e_y \\ e_z \end{bmatrix}_{t} - \begin{bmatrix} e_x \\ e_y \\ e_z \end{bmatrix}_{t-1} \right )
$$

计算误差后，可用来修正三轴陀螺仪误差。修正方法是直接用陀螺仪之前用作计算的数值加上计算误差值如下

$$
\begin{bmatrix} 
\bar{\omega_x} \\ \bar{\omega_y} \\ \bar{\omega_z} \end{bmatrix} =\begin{bmatrix} 
\omega_x \\ \omega_y \\ \omega_z \end{bmatrix} + \begin{bmatrix} 
\bar{e_x} \\ \bar{e_y} \\ \bar{e_z} \end{bmatrix}
$$


已经得到了四元数的微分表达形式；进一步地，需要将微分表达式离散化才能基于四元数的姿态更新。

四元数的微分形式表示如下，详细请参考以上介绍：

$$
\begin{bmatrix} \bar{q_w} \\ \bar{q_x} \\ \bar{q_y} \\ \bar{q_z} \end{bmatrix} = 
\begin{bmatrix} 
q_w \\ q_x \\ q_y \\ q_z 
\end{bmatrix} + 
\frac {\Delta t}{2}
\begin{bmatrix}
-\bar{\omega_x} q_x - \bar{\omega_y} q_y - \bar{\omega_z} q_z \\
\bar{\omega_x} q_w - \bar{\omega_y} q_z + \bar{\omega_z} q_y \\
\bar{\omega_x} q_z + \bar{\omega_y} q_w - \bar{\omega_z} q_x \\
-\bar{\omega_x} q_y + \bar{\omega_y} q_x + \bar{\omega_z}q_w
\end{bmatrix}
$$

$$
\Delta t = \frac {1}{采样频率 H_z}
$$

完成所有计算后需要作单位化四元数处理，以确保四元数在迭代过程中保持对不同数据特征进行公平一致的处理，从而防止误差，这有助于避免数值不稳定，提高计算效率，并使算法按预期运行。


利用以上这个误差来修正 DCM 矩阵中的四元素，矩阵的作用就是将 b (传感器) 坐标系和 n (NED) 坐标係正确的转化直到重合。实际上这种修正方法只把 b 系和 n 系的 $X$ 轴及 $Y$ 轴平面重合起来，对于 $z$ 轴旋转的偏航，加速度计则计算不到，由于加速度计无法感知 $z$ 轴上的旋转运动，所以需要用磁力计来进一步补偿。

两个向量的叉积得到的结果是两个向量的模与夹角正弦的乘积 $a \otimes v = ┃a┃ \cdot ┃v┃ sin \theta$，加速度计测量得到的重力向量和预测得到的机体重力向量已经经过单位化，因而他们的模是 **1**，也就是说它们向量的叉积结果仅与 $sin \theta$ 有关，当角度很小时，叉积结果可以近似于角度成正比。
 

### 磁力计北向校正

磁力计四元数北向校正是指利用磁力计修正计算得到的姿态四元数的偏航（北）方向。这通常分两步进行：首先利用加速度计校正俯仰角和横滚角，然后利用磁力计将测得的磁场水平投影与已知的北向矢量进行比较，从而校正偏航角。该过程通常需要使用互补滤波器或卡尔曼滤波器，其中磁力计数据用于校正陀螺仪偏航角估计中的漂移。

步骤 1：

 - 使用加速度计校正俯仰角和横滚角。
 - 使用加速度计获取重力方向。将此重力矢量与当前姿态估计值进行比较。
 - 基于这两个矢量之间的角度计算误差四元数 $(q_{ae})$。
 - 将当前姿态四元数 $(q_{k})$ 乘以此误差四元数，得到一个新的四元数 $(q_{a})$，用于校正俯仰角和横滚角：
    - $q_{a}=q_{ae} \otimes q_{k}$。

步骤 2：
 - 使用磁力计校正偏航角。利用步骤 1 中的四元数 $(q_{a})$ 将磁力计的原始测量矢量旋转到世界坐标系中。
 - 将旋转后的磁场矢量投影到水平面上，以消除垂直分量。
 - 如果偏航角正确，则得到的矢量应指向北方。如果不是，则计算误差四元数 $(q_{ma})$ 以使投影矢量与北方对齐。
 - 最终的姿态四元数是通过将上一步中经过偏航角校正的四元数与这个新的基于磁力计的校正四元数相加得到的。

磁力计的精度高度依赖于正确的校准，以消除传感器偏差和局部磁场的硬铁效应。如果没有正确的校准，磁力计可能会给出错误的北方读数。


$$
\begin{bmatrix} B_x \\ B_y \\ B_z \end{bmatrix} = C_R^b \cdot \begin{bmatrix} m_x \\ m_y \\ m_z \end{bmatrix} =
\begin{bmatrix}
q_w^2 \color{red}{+ q_x^2} - q_y^2 - q_z^2 & 2(q_xq_y \color{orange}{-} q_wq_z) & 2(q_xq_z \color{orange}{+} q_wq_y) \\
2(q_xq_y \color{orange}{+} q_wq_z) &  q_w^2 - q_x^2 \color{red}{+ q_y^2} - q_z^2 & 2(q_yq_z \color{orange}{-} q_wq_x) \\
2(q_xq_z \color{orange}{-} q_wq_y) & 2(q_yq_z \color{orange}{+} q_wq_x) &  q_w^2 - q_x^2 - q_y^2 \color{red}{+ q_z^2}
\end{bmatrix} \cdot \begin{bmatrix} m_x \\ m_y \\ m_z \end{bmatrix}
$$


$$
B_x = 2(q_w^2+q_x^2-0.5) \cdot m_x + 2(q_xq_y - q_wq_z) \cdot m_y + 2(q_xq_z + q_wq_y) \cdot m_z，\\
B_y = 2(q_xq_y + q_wq_z) \cdot m_x + 2(q_w^2+q_y^2-0.5) \cdot m_y + 2(q_yq_z - q_wq_x) \cdot m_z，\\
B_z = 2(q_xq_z - q_wq_y) \cdot m_x + 2(q_yq_z + q_wq_x) \cdot m_y + 2(q_w^2+q_z^2-0.5) \cdot m_z;
$$


$$
B_h = \sqrt{h_x^2 + h_y^2}
$$

地球磁场的方向在 **地表外部由地理南极指向地理北极**，在地表内部则由北向南。而磁场的局部方向则取决于特定来源或地球的地磁场。

理论地磁向量 $\hat{m}$ 如下：

$$
\hat{m} = C_R^b \cdot \begin{bmatrix}B_h \\ 0 \\ B_z \end{bmatrix} 
$$
 
$$
\begin{bmatrix} \hat{m_x} \\ \hat{m_y} \\ \hat{m_z} \end{bmatrix} = \begin{bmatrix}
q_w^2 \color{red}{+ q_x^2} - q_y^2 - q_z^2 & 2(q_xq_y \color{orange}{-} q_wq_z) & 2(q_xq_z \color{orange}{+} q_wq_y) \\
2(q_xq_y \color{orange}{+} q_wq_z) &  q_w^2 - q_x^2 \color{red}{+ q_y^2} - q_z^2 & 2(q_yq_z \color{orange}{-} q_wq_x) \\
2(q_xq_z \color{orange}{-} q_wq_y) & 2(q_yq_z \color{orange}{+} q_wq_x) &  q_w^2 - q_x^2 - q_y^2 \color{red}{+ q_z^2}
\end{bmatrix} \cdot \begin{bmatrix}B_h \\ 0 \\ B_z \end{bmatrix} 
$$

$$
\hat{m_x} = (q_w^2 \color{red}{+ q_x^2} - q_y^2 - q_z^2) B_h + 2(q_xq_z \color{orange}{+} q_wq_y)B_z；\\
\hat{m_y} = 2(q_xq_y \color{orange}{+} q_wq_z) B_h + 2(q_yq_z \color{orange}{-} q_wq_x) B_z;\\
\hat{m_z} = 2(q_xq_z \color{orange}{-} q_wq_y) B_h + (q_w^2 - q_x^2 - q_y^2 \color{red}{+ q_z^2})B_z;
$$

halfwx = bx * (0.5f - q2q2 - q3q3) + bz * (q1q3 - q0q2);
halfwy = bx * (q1q2 - q0q3) + bz * (q0q1 + q2q3);
halfwz = bx * (q0q2 + q1q3) + bz * (0.5f - q1q1 - q2q2);  

## 姿态变化计算原理

DCM 算法通过连纹更新加速度计、陀螺仪和磁力计等传感器的数据，实时计算出机体的姿态变化。陀螺仪测量角速度，用于短时的姿态更新；而磁力计和加速度计则通过融合算法（如互补滤波或卡尔曼滤波）来校正长期漂移并确定绝对姿态。

现在倾向于使用四元数作为主要的姿态表示方式，因为四元数在处理连续旋转时具有更优的数值稳定性，并且能够避免 DCM 可能出现的奇异性问题。但对于理解 DCM 的工作原理对于理解姿态解算的基础仍然十分重要。

 - 读取陀螺仪测得的角速度数据，并将其积分得到瞬时姿态变化的角度。
 - 使 DCM 更新陀螺仪数据通过欧拉角或旋转向量的形式更新方向余弦矩阵（DCM），反映机体在三维空间中的旋转情况。
 - 磁力计和加速度计数据融合。使用磁力计数据更新航向 (yaw) - $\psi_z$，并通过加速度计结合重力矢量估算俯仰 (pitch) - $\phi_y$ 和横滚角 (roll) - $\theta_x$。
 - 使用互补滤波或其他卡尔曼滤波等算法融合这些数据以减少传感器噪声和漂移影响
 - DCM 正交化和归一化。由于累积误差可能导致 DCM 不再代表正交旋转矩阵，需要定期进行正交化和单位化操作确保其有效性。
 - 转换至四元数。尽管 DCM 可以表示姿态，但因数值稳定性和方便后续运算的原因，一般会把更新后的 DCM 转换成四元数用作计算。

![Alt X](../assets/img/3d/gyro_acc.png)

在载体没有平移运动的情况下，通过加速度感知重力分量，可以计算出载体的俯仰和横滚；磁力计可以感知磁北方向，因此可以计算载体的磁北航向；而陀螺仪测量输出载体的旋转角速度，通过积分可以计算得到横滚、俯仰、航向增量，但由于陀螺输出值含有误差，采用积分计算，误差会随着时间累积。陀螺仪动态响应特性良好，但计算姿态时会产生累积误差， 磁力计和加速度计测量姿态没有累积误差，但动态响应较差，那么采用加速度计和磁力计的即时输出值对陀螺进行修正，则可以达到优势互补的效果，提高测量精度和系统的动态性能。

对于六轴数据，计算角度有两种方法：

 - 一种是通过对角速度积分得到角度，
 - 一种则是通过对加速度进行正交分解得到角度。


但这两种方式均存在不足，通过角速度积分得到角度时，角速度的误差会在积分过程中被不断放大从而影响数据准确性。而加速度计是一种特别敏感的传感器，电机旋转产生的震动会给加速度计的数据中带来高频噪声。

第一种方法测得的数据中存在**结果偏差**，而第二种方法测得的数据中存在**高频噪声**。因此可通过融合两种数据以获得准确姿态，这里通过加速度计补偿角速度。




# Mahony 滤波器 C 代码

Mahony Filter 将加速计读值和转换后的重力向量做外积 (Cross Product)，两个向量的外积代表两个向量的差异。 这个差异，Mahony Filter 以 Kp 调整，调整过后的值用来修正陀螺仪 $ \omega $ 读值，然后四元素就用以下公式来更新。

$$
q_{\omega,t} = q_{t-1} + \frac{1}{2} \left (q_{t-1} \cdot S_{\omega_t} \right) \cdot \Delta t
$$


姿态航向参考系统（AHRS）结合陀螺仪、加速度计和磁力计的数据来计算物体的姿态。

 - 陀螺仪测量角速度，但其数值会随时间漂移，因此需要使用加速度计和磁力计来校正这种漂移。
 - 加速度计通过测量重力来提供俯仰角和横滚角
 - 磁力计则通过感知地球磁场来提供航向角。

重力矢量和磁场矢量的叉积提供了一个参考坐标，帮助系统计算航向角并校正误差。


|传感器|功能|局限性|相關角度|
|:---:|:---:|:---:|:---:|
|陀螺仪|测量旋转速率，并通过积分计算姿态|易受噪声和偏差的影响，随时间推移发生漂移，导致误差累积|$\omega_t$|
|加速度计|测量线性加速度，可通过感知重力方向（在最小加速度下）确定俯仰角和横滚角|在运动或振动过程中，难以准确确定倾斜角|Pitch, Roll|
|磁力计|测量地球磁场以确定航向|易受附近金属或电子设备产生的局部磁场干扰，导致航向读数不准确|Yaw|


协同工作

 - 陀螺仪的测量值用于预测新的姿态，但该预测值会随时间推移而发生漂移
 - 加速度计像水平仪用于校正预测值
 - 磁力计像指南针，指向北方用于校正预测值
 - 叉积(Cross Product)是一项关键的校正技术是利用测得的重力矢量和磁场矢量的叉积。可以创建一个稳定的参考，用于改进姿态估计，特别是航向角（偏航角 - Yaw）。
 - 滤波器等复杂的算法来融合来自所有三个传感器的数据，从而生成物体姿态（俯仰角、横滚角和偏航角）的稳定且精确的估计值。更可以利用重力和磁场信息进行自我校正，从而保持正确的方向。