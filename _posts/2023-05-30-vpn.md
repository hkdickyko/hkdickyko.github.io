---
category: [軟件]
tags: [電腦]
title: WireGuard VPN (DeepIn)
date: 2023-05-29 1:00:00
---

<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
    overflow:hidden;
  }
</style>





## 简介

WireGuard 通过添加一个（或多个）网络接口来工作，称为 wg0、wg1、wg2、wg3 等。然后可以使用 ifconfig 或 ip-address 正常配置此网络接口。使用 route 或 ip-route 网络程序添加或删除路由等等。所有 WireGuard 的接口可用特定 wg 工具进行配置也充当 VPN 接口。

WireGuard 将隧道 IP 地址与公钥和远程端点相关联。 

### 当接口向客户端发送数据包时，它会执行以下操作：

- 此数据包适用于 192.168.30.8。它是客户端 ABCDEFGH 發出。如它不适用于任何已配置的客户端，则丢弃该数据包。

- 使用客户端 ABCDEFGH 的公钥加密整个 IP 数据包。

- 客户端 ABCDEFGH 的远程端点是主机 216.58.211.110 上的 UDP 端口 53133。

- 使用 UDP 通过将步骤 2 中的加密字节发送到 216.58.211.110:53133。

### 当接口收到数据包时，会发生以下情况：

主机 98.139.183.24 上的 UDP 端口 7361 收到一个数据包。解密如下。

- 它为客户端 LMNOPQRS 正确解密和验证。 记住客户端 LMNOPQRS 的最近互联网端点是 98.139.183.24:7361 使用 UDP。

- 解密后，明文数据包来自 192.168.43.89。 是否允许对等 LMNOPQRS 以 192.168.43.89 的形式向我们发送数据包？如果是，则在接口上接受数据包。 如果没有，放弃它。

服务器计算机可能具有以下配置：


```
[Interface]
PrivateKey = yAnz5TF+lXXJte14tji3zlMNq+hd2rYUIgJBgB3fBmk=
ListenPort = 51820

[Peer]
PublicKey = xTIBA5rboUvnH4htodjb6e697QjLERt1NAB4mZqp8Dg=
AllowedIPs = 10.192.122.3/32, 10.192.124.1/24

[Peer]
PublicKey = TrMvSoP4jYQlY6RIzBgbssQqY3vxI2Pi+y71lOWWXX0=
AllowedIPs = 10.192.122.4/32, 192.168.0.0/16

[Peer]
PublicKey = gN65BkIKy1eCE9pP1wdc8ROUtkHLF2PfAqYdyYBz6EA=
AllowedIPs = 10.10.10.230/32
```

客户端计算机可能具有以下更简单的配置：

```
[Interface]
PrivateKey = gI6EdUSYvn8ugXOt8QQD6Yc+JyiZxIhp3GInSWRfWGE=
ListenPort = 21841

[Peer]
PublicKey = HIgo9xNzJMWLKASShiTqIybxZ0U3wGLiUeJ1PKf8ykw=
Endpoint = 192.95.5.69:51820
AllowedIPs = 0.0.0.0/0
```

[網上资源](https://github.com/deepin-community/wireguard)

## 安裝教学

下載並解壓

```shell
$ cd src
$ make
```
除了需要安裝 C 编译器及相關的 libc 之外，没有其它依赖项。

```shell
$ make install
```

## 密匙生成

WireGuard 需要 base64 编码的公密匙和私密匙。可以使用 wg 实用程序生成。


### 生成私密匙

```shell
$ umask 077
$ wg genkey > privatekey
$ sudo mv privatekey /etc/wireguard/privatekey
```

创建私密匙后可以从私密匙中导出公密匙如下。

### 生成公密匙

```shell
$ wg pubkey < privatekey > publickey
$ sudo mv publickey /etc/wireguard/publickey
```

服务端及客户端也要生成各自的加密锁匙。


## 命令行添加新接口

可以通过 ip-link 添加新接口，它自动处理模块加载。

```
$ ip link add dev wg0 type wireguard
```

## 命令行添加 IP 地址

可以使用 ifconfig 或 ip-address 分配 IP 地址

```
$ ip address add dev wg0 192.168.2.1/24
```

接口可以使用設定檔案配置如下:

```
$ wg setconf wg0 myconfig.conf
```

### 配置文件 myconfig.conf 格式示例

此示例可用作编写配置文件的模型，遵循类似 INI 的语法。 在 “#” 之后并包含 “#” 的字符被视为注释会被忽略。

```
[Interface]
PrivateKey = yAnz5TF+lXXJte14tji3zlMNq+hd2rYUIgJBgB3fBmk=
ListenPort = 51820

[Peer]
PublicKey = xTIBA5rboUvnH4htodjb6e697QjLERt1NAB4mZqp8Dg=
Endpoint = 192.95.5.67:1234
AllowedIPs = 10.192.122.3/32, 10.192.124.1/24

[Peer]
PublicKey = TrMvSoP4jYQlY6RIzBgbssQqY3vxI2Pi+y71lOWWXX0=
Endpoint = [2607:5300:60:6b0::c05f:543]:2468
AllowedIPs = 10.192.122.4/32, 192.168.0.0/16

[Peer]
PublicKey = gN65BkIKy1eCE9pP1wdc8ROUtkHLF2PfAqYdyYBz6EA=
Endpoint = test.wireguard.com:18981
AllowedIPs = 10.10.10.230/32
```

客户端可能包含以下字段：

- PublicKey 由 wg pubkey 从私钥计算出的 base64 公钥，通常带外传输给配置文件的作者。 必需的。
- PresharedKey — 由 wg genpsk 生成的 base64 预共享密钥。 可选的，可以省略。 此选项添加了一个额外的对称密钥加密层，以混合到现有的公钥加密中，以实现后量子抵抗。
- AllowedIPs 一个逗号分隔的 IP（v4 或 v6）地址列表，带有 CIDR 掩码，允许此客户端的传入流量来自这些地址，并将此客户端的传出流量定向到该地址。 可以指定包罗万象的 0.0.0.0/0 来匹配所有 IPv4 地址，也可以指定 ::/0 来匹配所有 IPv6 地址。 可以指定多次。

- Endpoint 端点 IP 或主机名，后跟冒号，然后是端口号。 此端点将自动更新为来自客户端的正确验证数据包的最新源 IP 地址和端口。 选修的。

- PersistentKeepalive 一个秒间隔，介于 1 和 65535 之间，包括多长时间向客户端发送经过身份验证的空数据包，以保持状态防火墙或 NAT 映射持久有效。 例如，如果接口很少发送流量，但它可能随时从对等方接收流量，并且位于 NAT 之后，则接口可能受益于 25 秒的持久保持连接间隔。 如果设置为 0 或“关闭”，则禁用此选项。 默认情况下或未指定时，此选项处于关闭状态。 大多数用户不需要这个。 选修的。

或命令行輸入如下:

```
$ wg set wg0 listen-port 51820 private-key /path/to/private-key peer ABCDEF... allowed-ips 192.168.88.0/24 endpoint 209.202.254.14:8172
```

## 命令行激活接口

最后，可以使用 ifconfig 或 ip-link 激活接口。


```shell
$ ip link set up dev wg0
```

## 查看当前配置

用 wg show 或 wg showconf 命令，查看当前配置。 不带参数调用 wg 默认为调用 wg show。