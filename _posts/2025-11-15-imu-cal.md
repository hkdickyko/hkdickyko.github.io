---
category: [MPU]
tags: [IoT, 编程, 数学]
title: IMU 姿态计算方法
date: 2025-11-15 12:00:00
---

<style>
  table {
    width: 100%
    }
  td.left {
    vertical-align: center;
    text-align: left;
    width: 30%;
  }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  tr:nth-child(even){
    background-color:#ffffe5;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>


# IMU 姿态计算方法

以三轴陀螺仪、三轴加速度计、三轴磁力计和气压计做说明，首先要先了解三轴之间的关系，假设有三个向量 $X、Y、Z$，其方向分别为三个轴的方向，那这三个向量会互相垂直、正交（Orthogonality），也就像是 $X dot product Y = 0$ 或 $X cross product Y = Z$。可用右手定则来了解。


罗德里格旋转是指计算三维空间中一个向量绕指定旋转轴旋转给定角度后的新向量的公式。它在原文中被用来推导四元数表示旋转的定理。具体来说，罗德里格旋转公式是：


基本公式

$$
v{'} = v \cos \theta + (u \times v) \sin \theta + u(u \cdot v)(1 - \cos \theta)
$$


分项解释
 - $v^{'}$ - 旋转后的新向量
 - $v$ - 原始向量
 - $u$ - 单位旋转轴向量
 - $\theta$ - 旋转角度
 - $\times$ - 叉乘（向量积）
 - $\cdot$ - 点乘（点积）
 - $\cos \theta$ 和 $\sin \theta$ - 三角函数 


这个公式利用了原始向量、旋转轴和它们的叉积来表示旋转后的新向量。在原文中，它被用来通过四元数乘法来实现向量的旋转。

任意向量 $v$ 绕着以单位向量定义的旋转轴 $u$ 旋转 $\theta$ 度后的 $v^{'}$ 可以使用四元数乘法来获得四元数旋转公式：


$$
v^{'} = q v q^{*} = q v q^{-1}
$$


$$
v = \begin{bmatrix}0， v \end{bmatrix} ， q = \begin{bmatrix} cos\left(\frac{\theta}{2}\right)，sin\left(\frac{\theta}{2}\right) u \end{bmatrix}
$$


任意向量 $v$ 沿着以单位向量定义的旋转轴 $u$ 旋转 $\theta$ 角度后的 $v^{'}$ 可以使用矩阵乘法来获得：

$$
v^{'} = \begin{bmatrix}
 q_w^2 + q_x^2 - q_y^2 - q_z^2 & 2(q_xq_y + q_wq_z) & 2(q_xq_z - q_wq_y) \\
2(q_xq_y - q_wq_z) &  q_w^2 - q_x^2 + q_y^2 - q_z^2 & 2(q_yq_z + q_wq_x) \\
2(q_xq_z + q_wq_y) & 2(q_yq_z - q_wq_x) &  q_w^2 - q_x^2 - q_y^2 + q_z^2
\end{bmatrix} v
$$


同样也是将向量从机体坐标系 b 到大地坐标系 R 的姿态矩阵 
$C_b^R$（也称为坐标转换矩阵）即为：

$$
C_b^R = \begin{bmatrix}
 q_w^2 + q_x^2 - q_y^2 - q_z^2 & 2(q_xq_y + q_wq_z) & 2(q_xq_z - q_wq_y) \\
2(q_xq_y - q_wq_z) &  q_w^2 - q_x^2 + q_y^2 - q_z^2 & 2(q_yq_z + q_wq_x) \\
2(q_xq_z + q_wq_y) & 2(q_yq_z - q_wq_x) &  q_w^2 - q_x^2 - q_y^2 + q_z^2
\end{bmatrix}
$$





![Alt X](../assets/img/3d/DCM.png)

## 姿态变化计算原理

DCM 算法通过连纹更新加速度计、陀螺仪和磁力计等传感器的数据，实时计算出机体的姿态变化。陀螺仪测量角速度，用于短时的姿态更新；而磁力计和加速度计则通过融合算法（如互补滤波或卡尔曼滤波）来校正长期漂移并确定绝对姿态。

现在倾向于使用四元数作为主要的姿态表示方式，因为四元数在处理连续旋转时具有更优的数值稳定性，并且能够避免 DCM 可能出现的奇异性问题。但对于理解 DCM 的工作原理对于理解姿态解算的基础仍然十分重要。

 - 读取陀螺仪测得的角速度数据，并将其积分得到瞬时姿态变化的角度。
 - 使 DCM 更新陀螺仪数据通过欧拉角或旋转向量的形式更新方向余弦矩阵（DCM），反映机体在三维空间中的旋转情况。
 - 磁力计和加速度计数据融合。使用磁力计数据更新航向 (yaw) - $\psi_z$，并通过加速度计结合重力矢量估算俯仰 (pitch) - $\phi_y$ 和横滚角 (roll) - $\theta_x$。
 - 使用互补滤波或其他卡尔曼滤波等算法融合这些数据以减少传感器噪声和漂移影响
 - DCM 正交化和归一化。由于累积误差可能导致 DCM 不再代表正交旋转矩阵，需要定期进行正交化和单位化操作确保其有效性。
 - 转换至四元数。尽管 DCM 可以表示姿态，但因数值稳定性和方便后续运算的原因，一般会把更新后的 DCM 转换成四元数用作计算。

![Alt X](../assets/img/3d/gyro_acc.png)

在载体没有平移运动的情况下，通过加速度感知重力分量，可以计算出载体的俯仰和横滚；磁力计可以感知磁北方向，因此可以计算载体的磁北航向；而陀螺仪测量输出载体的旋转角速度，通过积分可以计算得到横滚、俯仰、航向增量，但由于陀螺输出值含有误差，采用积分计算，误差会随着时间累积。陀螺仪动态响应特性良好，但计算姿态时会产生累积误差， 磁力计和加速度计测量姿态没有累积误差，但动态响应较差，那么采用加速度计和磁力计的即时输出值对陀螺进行修正，则可以达到优势互补的效果，提高测量精度和系统的动态性能。

对于六轴数据，计算角度有两种方法：

 - 一种是通过对角速度积分得到角度，
 - 一种则是通过对加速度进行正交分解得到角度。


但这两种方式均存在不足，通过角速度积分得到角度时，角速度的误差会在积分过程中被不断放大从而影响数据准确性。而加速度计是一种特别敏感的传感器，电机旋转产生的震动会给加速度计的数据中带来高频噪声。

第一种方法测得的数据中存在**结果偏差**，而第二种方法测得的数据中存在**高频噪声**。因此可通过融合两种数据以获得准确姿态，这里通过加速度计补偿角速度。




# Mahony 滤波器 C 代码

Mahony Filter 将加速计读值和转换后的重力向量做外积 (Cross Product)，两个向量的外积代表两个向量的差异。 这个差异，Mahony Filter 以 Kp 调整，调整过后的值用来修正陀螺仪 $ \omega $ 读值，然后四元素就用以下公式来更新。

$$
q_{\omega,t} = q_{t-1} + \frac{1}{2} \left (q_{t-1} \cdot S_{\omega_t} \right) \cdot \Delta t
$$


姿态航向参考系统（AHRS）结合陀螺仪、加速度计和磁力计的数据来计算物体的姿态。

 - 陀螺仪测量角速度，但其数值会随时间漂移，因此需要使用加速度计和磁力计来校正这种漂移。
 - 加速度计通过测量重力来提供俯仰角和横滚角
 - 磁力计则通过感知地球磁场来提供航向角。

重力矢量和磁场矢量的叉积提供了一个参考坐标，帮助系统计算航向角并校正误差。


|传感器|功能|局限性|相關角度|
|:---:|:---:|:---:|:---:|
|陀螺仪|测量旋转速率，并通过积分计算姿态|易受噪声和偏差的影响，随时间推移发生漂移，导致误差累积|$\omega_t$|
|加速度计|测量线性加速度，可通过感知重力方向（在最小加速度下）确定俯仰角和横滚角|在运动或振动过程中，难以准确确定倾斜角|Pitch, Roll|
|磁力计|测量地球磁场以确定航向|易受附近金属或电子设备产生的局部磁场干扰，导致航向读数不准确|Yaw|


协同工作

 - 陀螺仪的测量值用于预测新的姿态，但该预测值会随时间推移而发生漂移
 - 加速度计像水平仪用于校正预测值
 - 磁力计像指南针，指向北方用于校正预测值
 - 叉积(Cross Product)是一项关键的校正技术是利用测得的重力矢量和磁场矢量的叉积。可以创建一个稳定的参考，用于改进姿态估计，特别是航向角（偏航角 - Yaw）。
 - 滤波器等复杂的算法来融合来自所有三个传感器的数据，从而生成物体姿态（俯仰角、横滚角和偏航角）的稳定且精确的估计值。更可以利用重力和磁场信息进行自我校正，从而保持正确的方向。