---
category: [積體電路]
tags: [IoT, 编程]
title: ESP 9250 九轴传感器
date: 2024-10-4 1:00:00
---
<style>
  table {
    width: 100%
    }
  td {
    vertical-align: center;
    text-align: center;
  }
  table.inputT{
    margin: 10px;
    width: auto;
    margin-left: auto;
    margin-right: auto;
    border: none;
  }
  input{
    text-align: center;
    padding: 0px 10px;
  }
  iframe{
    width: 100%;
    display: block;
    border-style:none;
  }
</style>

# ESP 9250 九轴传感器

传感器本身的噪声和误差，单独使用其中一个传感器进行姿态估计会存在一定程度的不准确性。为了提高精度和可靠性，可以使用扩展卡尔曼滤波（EKF）算法将这些不同传感器的数据进行融合处理。

MPU9250 是一种集成了三轴陀螺仪、三轴加速度计和三轴磁力计的九轴传感器。陀螺仪可以测量物体的角速度，加速度计可以测量物体的加速度，磁力计可以测量物体所受的磁场。数据融合的意义与挑战 在许多应用中，例如导航和姿态估计，需要准确地获取物体的姿态信息。然而，单独使用陀螺仪或加速度计进行姿态估计会存在一定程度的误差。陀螺仪存在漂移问题，长时间使用会导致姿态估计的误差累积；加速度计受重力等因素影响较大，短时间内的姿态估计较准确。因此，数据融合成为解决这一问题的有效手段。

### EKF算法理论基础 

 - 扩展卡尔曼滤波是卡尔曼滤波的一种扩展，用于非线性系统的状态估计。它通过在每一步迭代中对状态和协方差进行线性化来近似非线性系统。 EKF 通过状态预测和测量更新的方式，根据先验信息和测量信息来更新状态和协方差。
 - 状态量、控制量和观测量在 MPU9250 的数据融合算法中，选择四元数作为状态量，用来表示物体的姿态；陀螺仪采样值作为控制量，用来更新状态；三轴加速度计和磁偏角作为观测量，用来更新状态和协方差。

### MPU9250 九轴数据融合算法实现

 - 系统模型 根据物体的运动学方程和测量模型，可以建立物体的状态预测和测量更新模型。在状态预测中，利用陀螺仪的测量值对状态进行更新；在测量更新中，利用加速度计和磁偏角的测量值对状态和协方差进行更新。

#### EKF算法实现步骤

 - 初始化算法： 设置初始状态和初始协方差矩阵。
 - 状态预测： 利用陀螺仪的测量值进行状态的预测和协方差的更新。
 - 测量更新： 利用加速度计和磁偏角的测量值进行状态和协方差的更新。
 - 循环迭代： 重复执行步骤 **2** 和 **3**，融合每一时刻的陀螺仪、加速度计和磁偏角数据。

MPU9250 由 **2** 部分组成。
 - 一组是 **3** 轴加速度还有 **3** 轴陀螺仪，
 - 另一组则是 AKM 公司的 AK8963 轴磁力计。

所以，MPU9250 是一款 **9** 轴运动跟踪装置。封装中融合了 **3** 轴加速度，**3** 轴陀螺仪以及数字运动处理器 (DMP) 并且兼容 MPU6515。其完美的 I<sup>2</sup>C 方案，可直接输出 **9** 轴的全部数据。

## 寄存器

注意 **MPU9250** 的寄存器默认值都为 0，除了以下两个：

 - 0x6B(默认值 0x01)
 - 0x75(默认值 0x71)


### **0x6B** PWR_MGMT_1

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x6B	|PWR_MGMT_1|	H_RESET|	SLEEP	|CYCLE|-|-|-|-|-|

该寄存器用于配置 MPU9250 的模式，7 位用于重置设备，6 位用于唤醒 MPU9250。

由于 MPU650 在上电时会进入睡眠模式，因此为了兼容 MPU9250，建议上电时对此寄存器写入 **0x00**。


### **0x6A** USER_CTRL

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x6A	|USER_CTRL|-|	FIFO_EN|	I2C_MST_EN	|2C_IF_DIS|	-|-|-|-|

该寄存器用于配置 MPU9250 的功能，6 位用于使能 **FIFO**，5 位用于使能 **I2C** 主机模式，4 位用于使能 **SPI** 模式。


### **0x75** WHO_AM_I

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x75	|WHO_AM_I	|-|-|-|-|-|-|-|-|
该寄存器用于读取 MPU9250 的 ID 值，默认值为 0x71，可以用来验证通信是否成功。

### **0x1A** CONFIG

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x1A	|CONFIG	|-|-|	FSYNC_SET[2]|	FSYNC_SET[1]|	FSYNC_SET[0]|-|-|-	|

该寄存器用于配置 FSYNC (外部震荡源输入接口) 模式。

由于我们不使用 FSYNC，写入 0x00 即可。

### **0x38** INT_ENABLE

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x38|INT_ENABLE	|-|-|-|-|-|-|-|-|

用于配置中断，写入 0x00，不使用中断。


### **0x1B** GYRO_CONFIG

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x1B |	GYRO_CONFIG	|-|-|-	|	GYRO_FS[1]|	GYRO_FS[0]|	-|-	|-|

该寄存器可以设置陀螺仪的测量范围，下面是范围设置表：

|GYRO_FS[1]	|GYRO_FS[0]|	范围|
|:---:|:---:|:---:|
|0	|0|	±250°/s|
|0	|1	|±500°/s|
|1	|0	|±1000°/s|
|1	|1|	±2000°/s|

 - 寄存器 0x43
    - 从 0x43 到 0x48 这 6 个寄存器用于存储陀螺仪 X 轴，Y 轴，Z 轴的信息，每轴都是16 位的有符号 ADC 数据，数值实际范围由 GYRO_CONFIG 控制。

### **0x1C** ACCEL_CONFIG

|地址|寄存器|7|6|5|4|3|2|1|0|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|0x1C	|ACCEL_CONFIG|-|-|-			|ACCEL_FS[1]|	ACCEL_FS[0]|	-|-|-|

该寄存器可以设置加速度的测量范围，下面是范围设置表：

|ACCEl_FS[1]	|ACCEL_FS[0]|	范围|
|:---:|:---:|:---:|
|0|	0	|±2g|
|0	|1|	±4g|
|1|	0	|±8g|
|1	|1|	±16g|

 - 寄存器 0x3B
    - 从 0x3B 到 0x40 这六个寄存器用于存储加速度 X 轴，Y 轴，Z 轴的信息，每轴都是16 位的有符号 ADC 数据，数值实际范围由 ACCEL_CONFIG 控制。


### **0x41**

从 0x41 到 0x42 这两个寄存器用于存储温度的信息，是一个16 位的有符号数据。

 - 温度转换公式为：

$$
T_C = \frac{T_{out}–T_{offset}}{T_{Sensitivity}} + 21^\circ C
$$

 - 简化公式为：

$$
T_C = \frac {T_{out}–0}{321.0} + 21^\circ C
$$